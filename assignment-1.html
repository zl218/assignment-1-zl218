<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.8.21">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Zijie (Ian) Liang">
<meta name="dcterms.date" content="2025-10-01">

<title>CEVE 543 Fall 2025 Assigned 1: Nonstationary Rainfall Frequency Analysis</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdn.jsdelivr.net/npm/jquery@3.5.1/dist/jquery.min.js" integrity="sha384-ZvpUoO/+PpLXR1lu4jmpXWu80pZlYUAfxl5NsBMWOEPSjUn/6Z/hRTt8+pR6L4N2" crossorigin="anonymous"></script><script src="assignment-1_files/libs/clipboard/clipboard.min.js"></script>
<script src="assignment-1_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="assignment-1_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="assignment-1_files/libs/quarto-html/axe/axe-check.js" type="module"></script>
<script src="assignment-1_files/libs/quarto-html/popper.min.js"></script>
<script src="assignment-1_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="assignment-1_files/libs/quarto-html/anchor.min.js"></script>
<link href="assignment-1_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="assignment-1_files/libs/quarto-html/quarto-syntax-highlighting-ea1d7ac60288e0f1efdbc993fd8432ae.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="assignment-1_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="assignment-1_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="assignment-1_files/libs/bootstrap/bootstrap-da4eb6f0c61bad3e7da9824bbd1e5bab.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<script src="https://cdn.jsdelivr.net/npm/requirejs@2.3.6/require.min.js" integrity="sha384-c9c+LnTbwQ3aujuU7ULEPVvgLs+Fn6fJUvIGTsuu1ZcCf11fiEubah0ttpca4ntM sha384-6V1/AdqZRWk1KAlWbKBlGhN7VG4iE/yAZcO6NZPMF8od0vukrvr0tg4qY6NSrItx" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN" && texText && texText.data) {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul class="collapse">
  <li><a href="#tasks" id="toc-tasks" class="nav-link active" data-scroll-target="#tasks">Tasks</a></li>
  <li><a href="#task-1stationary-gev-analysis" id="toc-task-1stationary-gev-analysis" class="nav-link" data-scroll-target="#task-1stationary-gev-analysis"><span class="header-section-number">1</span> Task 1:Stationary GEV Analysis</a>
  <ul class="collapse">
  <li><a href="#data-setup-and-station-selection" id="toc-data-setup-and-station-selection" class="nav-link" data-scroll-target="#data-setup-and-station-selection"><span class="header-section-number">1.1</span> Data Setup and Station Selection</a></li>
  <li><a href="#gev-fitting-multiple-approaches" id="toc-gev-fitting-multiple-approaches" class="nav-link" data-scroll-target="#gev-fitting-multiple-approaches"><span class="header-section-number">1.2</span> GEV Fitting: Multiple Approaches</a></li>
  <li><a href="#compare-all-three-methods" id="toc-compare-all-three-methods" class="nav-link" data-scroll-target="#compare-all-three-methods"><span class="header-section-number">1.3</span> Compare All Three Methods</a></li>
  <li><a href="#calculate-50-year-and-100-year-return-period-estimation" id="toc-calculate-50-year-and-100-year-return-period-estimation" class="nav-link" data-scroll-target="#calculate-50-year-and-100-year-return-period-estimation"><span class="header-section-number">1.4</span> Calculate 50-year and 100-year Return Period Estimation</a></li>
  </ul></li>
  <li><a href="#task-2-multi-station-regional-analysis" id="toc-task-2-multi-station-regional-analysis" class="nav-link" data-scroll-target="#task-2-multi-station-regional-analysis"><span class="header-section-number">2</span> Task 2: Multi-station Regional Analysis</a>
  <ul class="collapse">
  <li><a href="#get-the-nearest-4-stations" id="toc-get-the-nearest-4-stations" class="nav-link" data-scroll-target="#get-the-nearest-4-stations"><span class="header-section-number">2.1</span> Get the Nearest 4 Stations</a></li>
  <li><a href="#plot-the-annual-data" id="toc-plot-the-annual-data" class="nav-link" data-scroll-target="#plot-the-annual-data"><span class="header-section-number">2.2</span> Plot The Annual Data</a></li>
  <li><a href="#fitting-gev-to-multiple-stations" id="toc-fitting-gev-to-multiple-stations" class="nav-link" data-scroll-target="#fitting-gev-to-multiple-stations"><span class="header-section-number">2.3</span> Fitting GEV to Multiple Stations</a></li>
  </ul></li>
  <li><a href="#task-3-nonstationarity-analysis" id="toc-task-3-nonstationarity-analysis" class="nav-link" data-scroll-target="#task-3-nonstationarity-analysis"><span class="header-section-number">3</span> Task 3: Nonstationarity Analysis</a>
  <ul class="collapse">
  <li><a href="#load-co2-data" id="toc-load-co2-data" class="nav-link" data-scroll-target="#load-co2-data"><span class="header-section-number">3.1</span> Load CO2 Data</a></li>
  <li><a href="#mann-kendall-trend-test" id="toc-mann-kendall-trend-test" class="nav-link" data-scroll-target="#mann-kendall-trend-test"><span class="header-section-number">3.2</span> Mann-Kendall Trend Test</a></li>
  <li><a href="#two-nonstationary-gev-models" id="toc-two-nonstationary-gev-models" class="nav-link" data-scroll-target="#two-nonstationary-gev-models"><span class="header-section-number">3.3</span> Two Nonstationary GEV models</a></li>
  <li><a href="#extracting-gev-distributions" id="toc-extracting-gev-distributions" class="nav-link" data-scroll-target="#extracting-gev-distributions"><span class="header-section-number">3.4</span> Extracting GEV Distributions</a></li>
  <li><a href="#model-comparison-and-uncertainty" id="toc-model-comparison-and-uncertainty" class="nav-link" data-scroll-target="#model-comparison-and-uncertainty"><span class="header-section-number">3.5</span> Model Comparison and Uncertainty</a></li>
  </ul></li>
  <li><a href="#task-4-regional-parameter-estimation" id="toc-task-4-regional-parameter-estimation" class="nav-link" data-scroll-target="#task-4-regional-parameter-estimation"><span class="header-section-number">4</span> Task 4: Regional Parameter Estimation</a>
  <ul class="collapse">
  <li><a href="#regional-model-design" id="toc-regional-model-design" class="nav-link" data-scroll-target="#regional-model-design"><span class="header-section-number">4.1</span> Regional Model Design</a></li>
  <li><a href="#comparing-regional-vs-single-station-approaches" id="toc-comparing-regional-vs-single-station-approaches" class="nav-link" data-scroll-target="#comparing-regional-vs-single-station-approaches"><span class="header-section-number">4.2</span> Comparing Regional vs Single-Station Approaches</a></li>
  </ul></li>
  <li><a href="#task-5-communication" id="toc-task-5-communication" class="nav-link" data-scroll-target="#task-5-communication"><span class="header-section-number">5</span> Task 5: Communication</a>
  <ul class="collapse">
  <li><a href="#question-1" id="toc-question-1" class="nav-link" data-scroll-target="#question-1"><span class="header-section-number">5.1</span> Question 1</a></li>
  <li><a href="#question-2" id="toc-question-2" class="nav-link" data-scroll-target="#question-2"><span class="header-section-number">5.2</span> Question 2</a></li>
  </ul></li>
  </ul>
<div class="quarto-alternate-formats"><h2>Other Formats</h2><ul><li><a href="assignment-1.pdf"><i class="bi bi-file-pdf"></i>Typst</a></li></ul></div></nav>
</div>
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">CEVE 543 Fall 2025 Assigned 1: Nonstationary Rainfall Frequency Analysis</h1>
<p class="subtitle lead">Houston Daily Rainfall Extremes and Climate Change</p>
</div>



<div class="quarto-title-meta">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Zijie (Ian) Liang </p>
          </div>
  </div>
    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 1, 2025</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<section id="tasks" class="level1 unnumbered">
<h1 class="unnumbered">Tasks</h1>
</section>
<section id="task-1stationary-gev-analysis" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Task 1:Stationary GEV Analysis</h1>
<section id="data-setup-and-station-selection" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="data-setup-and-station-selection"><span class="header-section-number">1.1</span> Data Setup and Station Selection</h2>
<section id="loading-required-packages" class="level3" data-number="1.1.1">
<h3 data-number="1.1.1" class="anchored" data-anchor-id="loading-required-packages"><span class="header-section-number">1.1.1</span> Loading Required Packages</h3>
<div id="2" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb1"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Pkg</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>lab_dir <span class="op">=</span> <span class="fu">dirname</span>(<span class="pp">@__FILE__</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="bu">Pkg</span>.<span class="fu">activate</span>(lab_dir)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="bu">Pkg</span>.<span class="fu">instantiate</span>()</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>First, load all the Julia packages I will use in this analysis:</p>
<div id="4" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb2"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Downloads</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">TidierFiles</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">TidierData</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">DataFrames</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Extremes</span></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Turing</span></span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Optim</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">ColorSchemes</span></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">CairoMakie</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">GeoMakie</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Random</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">MCMCChains</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Makie</span> </span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Unitful</span>          </span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">ArviZ</span></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">NCDatasets</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">LinearAlgebra</span>: I</span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Distributions</span></span>
<span id="cb2-19"><a href="#cb2-19" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">Statistics</span></span>
<span id="cb2-20"><a href="#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="im">using</span> <span class="bu">LaTeXStrings</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="6" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb3"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Configure plotting backend</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>CairoMakie.<span class="fu">activate!</span>(<span class="kw">type</span> <span class="op">=</span> <span class="st">"svg"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="cn">ENV</span>[<span class="st">"DATAFRAMES_ROWS"</span>] <span class="op">=</span> <span class="fl">5</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="8" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb4"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Utility functions</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">include</span>(<span class="st">"util.jl"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>rainfall_conversion <span class="op">=</span> Makie.<span class="fu">UnitfulConversion</span>(u<span class="st">"inch"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> <span class="fu">MersenneTwister</span>(<span class="fl">543</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
</section>
<section id="loading-noaa-precipitation-data" class="level3" data-number="1.1.2">
<h3 data-number="1.1.2" class="anchored" data-anchor-id="loading-noaa-precipitation-data"><span class="header-section-number">1.1.2</span> Loading NOAA Precipitation Data</h3>
<p>Like previous labs, I will download and read the Texas precipitation data:</p>
<div id="10" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-5"><pre class="sourceCode julia code-annotation-code code-with-copy code-annotated"><code class="sourceCode julia"><span id="annotated-cell-5-1"><a href="#annotated-cell-5-1" aria-hidden="true" tabindex="-1"></a>fname <span class="op">=</span> <span class="fu">joinpath</span>(lab_dir,<span class="st">"dur01d_ams_na14v11.txt"</span>)</span>
<span id="annotated-cell-5-2"><a href="#annotated-cell-5-2" aria-hidden="true" tabindex="-1"></a>url <span class="op">=</span> <span class="st">"https://hdsc.nws.noaa.gov/pub/hdsc/data/tx/dur01d_ams_na14v11.txt"</span></span>
<span id="annotated-cell-5-3"><a href="#annotated-cell-5-3" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="1">1</button><span id="annotated-cell-5-4" class="code-annotation-target"><a href="#annotated-cell-5-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> !<span class="fu">isfile</span>(fname)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-5" data-target-annotation="2">2</button><span id="annotated-cell-5-5" class="code-annotation-target"><a href="#annotated-cell-5-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Downloads</span>.<span class="fu">download</span>(url, fname)</span>
<span id="annotated-cell-5-6"><a href="#annotated-cell-5-6" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-5" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="4" data-code-annotation="1">Check if data file already exists locally</span>
</dd>
<dt data-target-cell="annotated-cell-5" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-5" data-code-lines="5" data-code-annotation="2">Download the file if it doesn‚Äôt exist</span>
</dd>
</dl>
</div>
</div>
<div id="12" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-6"><pre class="sourceCode julia code-annotation-code code-with-copy code-annotated"><code class="sourceCode julia"><button class="code-annotation-anchor" data-target-cell="annotated-cell-6" data-target-annotation="1">1</button><span id="annotated-cell-6-1" class="code-annotation-target"><a href="#annotated-cell-6-1" aria-hidden="true" tabindex="-1"></a>stations, rainfall_data <span class="op">=</span> <span class="fu">read_noaa_data</span>(fname)</span>
<span id="annotated-cell-6-2"><a href="#annotated-cell-6-2" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(stations)</span>
<span id="annotated-cell-6-3"><a href="#annotated-cell-6-3" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(rainfall_data)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-6" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-6" data-code-lines="1" data-code-annotation="1">Read and parse the NOAA precipitation data</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display">
<div><div style="float: left;"><span>816√ó7 DataFrame</span></div><div style="float: right;"><span style="font-style: italic;">811 rows omitted</span></div><div style="clear: both;"></div></div><div class="data-frame" style="overflow-x: scroll;">
<table class="data-frame caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;">Row</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">stnid</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">noaa_id</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">state</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">latitude</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">longitude</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">years_of_data</th>
</tr>
<tr class="subheader headerLastRow even">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">60-0011</td>
<td style="text-align: left;">CLEAR CK AT BAY AREA BLVD</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">29.4977</td>
<td style="text-align: right;">-95.1599</td>
<td style="text-align: right;">30</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">2</td>
<td style="text-align: right;">2</td>
<td style="text-align: left;">60-0019</td>
<td style="text-align: left;">TURKEY CK AT FM 1959</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">29.5845</td>
<td style="text-align: right;">-95.1869</td>
<td style="text-align: right;">30</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">3</td>
<td style="text-align: right;">3</td>
<td style="text-align: left;">60-0022</td>
<td style="text-align: left;">ARMAND BYU AT GENOARED BLF RD</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">29.6345</td>
<td style="text-align: right;">-95.1123</td>
<td style="text-align: right;">31</td>
</tr>
<tr class="even">
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">815</td>
<td style="text-align: right;">815</td>
<td style="text-align: left;">87-0031</td>
<td style="text-align: left;">SECO CREEK AT MILLER RANCH</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">29.5731</td>
<td style="text-align: right;">-99.4028</td>
<td style="text-align: right;">20</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">816</td>
<td style="text-align: right;">816</td>
<td style="text-align: left;">99-2048</td>
<td style="text-align: left;">COTULLA</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">28.4567</td>
<td style="text-align: right;">-99.2183</td>
<td style="text-align: right;">102</td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="cell-output cell-output-display">
<div><div style="float: left;"><span>61925√ó4 DataFrame</span></div><div style="float: right;"><span style="font-style: italic;">61920 rows omitted</span></div><div style="clear: both;"></div></div><div class="data-frame" style="overflow-x: scroll;">
<table class="data-frame caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;">Row</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">stnid</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">date</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">year</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">rainfall</th>
</tr>
<tr class="subheader headerLastRow even">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Dates.Date">Date</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Union{Missing, Unitful.Quantity{Float64, ùêã, Unitful.FreeUnits{(inch,), ùêã, nothing}}}">Quantity‚Ä¶?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">1987-06-11</td>
<td style="text-align: right;">1987</td>
<td style="text-align: right;">6.31 inch</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">2</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">1988-09-02</td>
<td style="text-align: right;">1988</td>
<td style="text-align: right;">5.46 inch</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">3</td>
<td style="text-align: right;">1</td>
<td style="text-align: left;">1989-08-01</td>
<td style="text-align: right;">1989</td>
<td style="text-align: right;">11.39 inch</td>
</tr>
<tr class="even">
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">61924</td>
<td style="text-align: right;">816</td>
<td style="text-align: left;">2016-08-20</td>
<td style="text-align: right;">2016</td>
<td style="text-align: right;">3.44 inch</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">61925</td>
<td style="text-align: right;">816</td>
<td style="text-align: left;">2017-09-25</td>
<td style="text-align: right;">2017</td>
<td style="text-align: right;">2.72 inch</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p><strong>Choose Houston area station for analysis.</strong></p>
<div id="14" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-7"><pre class="sourceCode julia code-annotation-code code-with-copy code-annotated"><code class="sourceCode julia"><button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="1">1</button><span id="annotated-cell-7-1" class="code-annotation-target"><a href="#annotated-cell-7-1" aria-hidden="true" tabindex="-1"></a>target_location <span class="op">=</span> <span class="st">"Houston George Bush Intercontinental Airport"</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="2">2</button><span id="annotated-cell-7-2" class="code-annotation-target"><a href="#annotated-cell-7-2" aria-hidden="true" tabindex="-1"></a>target_lon <span class="op">=</span> <span class="op">-</span><span class="fl">95.3359296</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="3">3</button><span id="annotated-cell-7-3" class="code-annotation-target"><a href="#annotated-cell-7-3" aria-hidden="true" tabindex="-1"></a>target_lat <span class="op">=</span> <span class="fl">29.9732036</span></span>
<span id="annotated-cell-7-4"><a href="#annotated-cell-7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-5"><a href="#annotated-cell-7-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Haversine formula for great circle distance with units</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="4">4</button><span id="annotated-cell-7-6" class="code-annotation-target"><a href="#annotated-cell-7-6" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">calc_distance</span>(lon1, lat1, lon2, lat2)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="5">5</button><span id="annotated-cell-7-7" class="code-annotation-target"><a href="#annotated-cell-7-7" aria-hidden="true" tabindex="-1"></a>    R <span class="op">=</span> <span class="fl">6378.0</span>u<span class="st">"km"</span></span>
<span id="annotated-cell-7-8"><a href="#annotated-cell-7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-9"><a href="#annotated-cell-7-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Convert degrees to radians</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="6">6</button><span id="annotated-cell-7-10" class="code-annotation-target"><a href="#annotated-cell-7-10" aria-hidden="true" tabindex="-1"></a>    œÜ<span class="fl">1</span> <span class="op">=</span> <span class="fu">deg2rad</span>(lat1)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="7">7</button><span id="annotated-cell-7-11" class="code-annotation-target"><a href="#annotated-cell-7-11" aria-hidden="true" tabindex="-1"></a>    œÜ<span class="fl">2</span> <span class="op">=</span> <span class="fu">deg2rad</span>(lat2)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="8">8</button><span id="annotated-cell-7-12" class="code-annotation-target"><a href="#annotated-cell-7-12" aria-hidden="true" tabindex="-1"></a>    ŒîœÜ <span class="op">=</span> <span class="fu">deg2rad</span>(lat2 <span class="op">-</span> lat1)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="9">9</button><span id="annotated-cell-7-13" class="code-annotation-target"><a href="#annotated-cell-7-13" aria-hidden="true" tabindex="-1"></a>    ŒîŒª <span class="op">=</span> <span class="fu">deg2rad</span>(lon2 <span class="op">-</span> lon1)</span>
<span id="annotated-cell-7-14"><a href="#annotated-cell-7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-7-15"><a href="#annotated-cell-7-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Haversine formula</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="10">10</button><span id="annotated-cell-7-16" class="code-annotation-target"><a href="#annotated-cell-7-16" aria-hidden="true" tabindex="-1"></a>    a <span class="op">=</span> <span class="fu">sin</span>(ŒîœÜ <span class="op">/</span> <span class="fl">2</span>)<span class="op">^</span><span class="fl">2</span> <span class="op">+</span> <span class="fu">cos</span>(œÜ<span class="fl">1</span>) <span class="op">*</span> <span class="fu">cos</span>(œÜ<span class="fl">2</span>) <span class="op">*</span> <span class="fu">sin</span>(ŒîŒª <span class="op">/</span> <span class="fl">2</span>)<span class="op">^</span><span class="fl">2</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="11">11</button><span id="annotated-cell-7-17" class="code-annotation-target"><a href="#annotated-cell-7-17" aria-hidden="true" tabindex="-1"></a>    c <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> <span class="fu">atan</span>(<span class="fu">sqrt</span>(a), <span class="fu">sqrt</span>(<span class="fl">1</span> <span class="op">-</span> a))</span>
<span id="annotated-cell-7-18"><a href="#annotated-cell-7-18" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="12">12</button><span id="annotated-cell-7-19" class="code-annotation-target"><a href="#annotated-cell-7-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> R <span class="op">*</span> c</span>
<span id="annotated-cell-7-20"><a href="#annotated-cell-7-20" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="annotated-cell-7-21"><a href="#annotated-cell-7-21" aria-hidden="true" tabindex="-1"></a></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="13">13</button><span id="annotated-cell-7-22" class="code-annotation-target"><a href="#annotated-cell-7-22" aria-hidden="true" tabindex="-1"></a>stations <span class="op">=</span> <span class="pp">@chain</span> stations <span class="cf">begin</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="14">14</button><span id="annotated-cell-7-23" class="code-annotation-target"><a href="#annotated-cell-7-23" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@mutate</span>(distance_km <span class="op">=</span> <span class="fu">calc_distance</span>(longitude, latitude, !!target_lon, !!target_lat))</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="15">15</button><span id="annotated-cell-7-24" class="code-annotation-target"><a href="#annotated-cell-7-24" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@arrange</span>(distance_km)</span>
<span id="annotated-cell-7-25"><a href="#annotated-cell-7-25" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-7" data-target-annotation="16">16</button><span id="annotated-cell-7-26" class="code-annotation-target"><a href="#annotated-cell-7-26" aria-hidden="true" tabindex="-1"></a>stations</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-7" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="1" data-code-annotation="1">Descriptive name for my houston area target location</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="2" data-code-annotation="2">Houston George Bush Intercontinental Airport‚Äôs longitude coordinate (negative means west of Greenwich)</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="3" data-code-annotation="3">Houston George Bush Intercontinental Airport‚Äôs latitude coordinate (positive means north of equator)</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="6" data-code-annotation="4">Define a function that calculates great circle distance between two lat/lon points</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="7" data-code-annotation="5">Earth‚Äôs radius in kilometers (using proper units!)</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="10" data-code-annotation="6">Convert the first latitude from degrees to radians (œÜ is Greek phi)</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="7">7</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="11" data-code-annotation="7">Convert the second latitude to radians</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="8">8</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="12" data-code-annotation="8">Calculate difference in latitudes (Œî is Greek delta, means ‚Äúchange in‚Äù)</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="9">9</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="13" data-code-annotation="9">Calculate difference in longitudes (Œª is Greek lambda)</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="10">10</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="16" data-code-annotation="10">First part of Haversine formula: angular distance component</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="11">11</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="17" data-code-annotation="11">Complete the great circle distance calculation</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="12">12</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="19" data-code-annotation="12">Multiply by Earth‚Äôs radius to get distance in kilometers</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="13">13</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="22" data-code-annotation="13">Start a TidierData pipeline with our stations DataFrame</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="14">14</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="23" data-code-annotation="14">Add distance column using <code>!!</code> to inject external variables into the TidierData expression</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="15">15</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="24" data-code-annotation="15">Sort the stations by distance (closest first)</span>
</dd>
<dt data-target-cell="annotated-cell-7" data-target-annotation="16">16</dt>
<dd>
<span data-code-cell="annotated-cell-7" data-code-lines="26" data-code-annotation="16">Display the sorted stations (shows closest ones first due to ENV row limit)</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div><div style="float: left;"><span>816√ó8 DataFrame</span></div><div style="float: right;"><span style="font-style: italic;">811 rows omitted</span></div><div style="clear: both;"></div></div><div class="data-frame" style="overflow-x: scroll;">
<table class="data-frame caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;">Row</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">stnid</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">noaa_id</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">state</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">latitude</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">longitude</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">years_of_data</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">distance_km</th>
</tr>
<tr class="subheader headerLastRow even">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Unitful.Quantity{Float64, ùêã, Unitful.FreeUnits{(km,), ùêã, nothing}}">Quantity‚Ä¶</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1</td>
<td style="text-align: right;">782</td>
<td style="text-align: left;">79-0061</td>
<td style="text-align: left;">HOUSTON INTERCONT AP</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">29.98</td>
<td style="text-align: right;">-95.36</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">2.44121 km</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">2</td>
<td style="text-align: right;">387</td>
<td style="text-align: left;">41-4362</td>
<td style="text-align: left;">HUMBLE</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">30.0</td>
<td style="text-align: right;">-95.25</td>
<td style="text-align: right;">60</td>
<td style="text-align: right;">8.80564 km</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">3</td>
<td style="text-align: right;">6</td>
<td style="text-align: left;">60-0104</td>
<td style="text-align: left;">GREENS BYU AT MT HOUSTON PKWY</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">29.892</td>
<td style="text-align: right;">-95.238</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">13.0751 km</td>
</tr>
<tr class="even">
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">815</td>
<td style="text-align: right;">807</td>
<td style="text-align: left;">79-0125</td>
<td style="text-align: left;">EL PASO</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">31.7587</td>
<td style="text-align: right;">-106.484</td>
<td style="text-align: right;">60</td>
<td style="text-align: right;">1083.1 km</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">816</td>
<td style="text-align: right;">428</td>
<td style="text-align: left;">41-4931</td>
<td style="text-align: left;">LA TUNA 1 S</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">31.98</td>
<td style="text-align: right;">-106.597</td>
<td style="text-align: right;">69</td>
<td style="text-align: right;">1097.22 km</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="examining-the-closest-weather-station" class="level3" data-number="1.1.3">
<h3 data-number="1.1.3" class="anchored" data-anchor-id="examining-the-closest-weather-station"><span class="header-section-number">1.1.3</span> Examining the Closest Weather Station</h3>
<p>Focus on the closest weather station that near the Houston George Bush Intercontinental Airport and look at its rainfall data:</p>
<div id="16" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-8"><pre class="sourceCode julia code-annotation-code code-with-copy code-annotated"><code class="sourceCode julia"><span id="annotated-cell-8-1"><a href="#annotated-cell-8-1" aria-hidden="true" tabindex="-1"></a>closest_station <span class="op">=</span> <span class="fu">first</span>(stations)</span>
<span id="annotated-cell-8-2"><a href="#annotated-cell-8-2" aria-hidden="true" tabindex="-1"></a>closest_stnid <span class="op">=</span> closest_station.stnid</span>
<span id="annotated-cell-8-3"><a href="#annotated-cell-8-3" aria-hidden="true" tabindex="-1"></a>closest_rainfall <span class="op">=</span> <span class="pp">@chain</span> rainfall_data <span class="cf">begin</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-8" data-target-annotation="1">1</button><span id="annotated-cell-8-4" class="code-annotation-target"><a href="#annotated-cell-8-4" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@filter</span>(stnid <span class="op">==</span> !!closest_stnid)</span>
<span id="annotated-cell-8-5"><a href="#annotated-cell-8-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="annotated-cell-8-6"><a href="#annotated-cell-8-6" aria-hidden="true" tabindex="-1"></a>closest_rainfall</span>
<span id="annotated-cell-8-7"><a href="#annotated-cell-8-7" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"Station NOAA ID: "</span>, closest_station.noaa_id)</span>
<span id="annotated-cell-8-8"><a href="#annotated-cell-8-8" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"Station Name: "</span>, closest_station.name)</span>
<span id="annotated-cell-8-9"><a href="#annotated-cell-8-9" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(closest_rainfall)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-8" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-8" data-code-lines="4" data-code-annotation="1">Filter rainfall data using <code>!!</code> to inject the external variable into TidierData</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Station NOAA ID: 79-0061
Station Name: HOUSTON INTERCONT AP</code></pre>
</div>
<div class="cell-output cell-output-display">
<div><div style="float: left;"><span>48√ó4 DataFrame</span></div><div style="float: right;"><span style="font-style: italic;">43 rows omitted</span></div><div style="clear: both;"></div></div><div class="data-frame" style="overflow-x: scroll;">
<table class="data-frame caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;">Row</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">stnid</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">date</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">year</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">rainfall</th>
</tr>
<tr class="subheader headerLastRow even">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Dates.Date">Date</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Union{Missing, Unitful.Quantity{Float64, ùêã, Unitful.FreeUnits{(inch,), ùêã, nothing}}}">Quantity‚Ä¶?</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1</td>
<td style="text-align: right;">782</td>
<td style="text-align: left;">1970-05-15</td>
<td style="text-align: right;">1970</td>
<td style="text-align: right;">4.23 inch</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">2</td>
<td style="text-align: right;">782</td>
<td style="text-align: left;">1971-12-01</td>
<td style="text-align: right;">1971</td>
<td style="text-align: right;">3.09 inch</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">3</td>
<td style="text-align: right;">782</td>
<td style="text-align: left;">1972-03-20</td>
<td style="text-align: right;">1972</td>
<td style="text-align: right;">6.73 inch</td>
</tr>
<tr class="even">
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">47</td>
<td style="text-align: right;">782</td>
<td style="text-align: left;">2016-04-17</td>
<td style="text-align: right;">2016</td>
<td style="text-align: right;">9.79 inch</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">48</td>
<td style="text-align: right;">782</td>
<td style="text-align: left;">2017-08-26</td>
<td style="text-align: right;">2017</td>
<td style="text-align: right;">16.3 inch</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="plotting-a-time-series-for-the-station" class="level3" data-number="1.1.4">
<h3 data-number="1.1.4" class="anchored" data-anchor-id="plotting-a-time-series-for-the-station"><span class="header-section-number">1.1.4</span> Plotting a Time Series For the Station</h3>
<p>Create a time series plot to see how rainfall has changed over time at this station:</p>
<div id="20" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb6"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_time_series</span>(closest_station, closest_rainfall)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="assignment-1_files/figure-html/cell-11-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="18" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-9"><pre class="sourceCode julia code-annotation-code code-with-copy code-annotated"><code class="sourceCode julia"><span id="annotated-cell-9-1"><a href="#annotated-cell-9-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plot_time_series</span>(station_row, rainfall_df)</span>
<span id="annotated-cell-9-2"><a href="#annotated-cell-9-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Create time series plot of rainfall data</span></span>
<span id="annotated-cell-9-3"><a href="#annotated-cell-9-3" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size <span class="op">=</span> (<span class="fl">800</span>, <span class="fl">400</span>))</span>
<span id="annotated-cell-9-4"><a href="#annotated-cell-9-4" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>],</span>
<span id="annotated-cell-9-5"><a href="#annotated-cell-9-5" aria-hidden="true" tabindex="-1"></a>        ylabel <span class="op">=</span> <span class="st">"Annual Maximum Rainfall"</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="1">1</button><span id="annotated-cell-9-6" class="code-annotation-target"><a href="#annotated-cell-9-6" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="st">"</span><span class="sc">$</span>(station_row.noaa_id)<span class="st">: </span><span class="sc">$</span>(station_row.name)<span class="st">"</span>,</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="2">2</button><span id="annotated-cell-9-7" class="code-annotation-target"><a href="#annotated-cell-9-7" aria-hidden="true" tabindex="-1"></a>        dim2_conversion <span class="op">=</span> rainfall_conversion)</span>
<span id="annotated-cell-9-8"><a href="#annotated-cell-9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-9"><a href="#annotated-cell-9-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot the time series</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="3">3</button><span id="annotated-cell-9-10" class="code-annotation-target"><a href="#annotated-cell-9-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines!</span>(ax, rainfall_df.date, rainfall_df.rainfall)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-9" data-target-annotation="4">4</button><span id="annotated-cell-9-11" class="code-annotation-target"><a href="#annotated-cell-9-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scatter!</span>(ax, rainfall_df.date, rainfall_df.rainfall,</span>
<span id="annotated-cell-9-12"><a href="#annotated-cell-9-12" aria-hidden="true" tabindex="-1"></a>        markersize <span class="op">=</span> <span class="fl">10</span>, marker <span class="op">=</span> <span class="op">:</span>circle, strokewidth <span class="op">=</span> <span class="fl">2</span>, color <span class="op">=</span> <span class="op">:</span>transparent)</span>
<span id="annotated-cell-9-13"><a href="#annotated-cell-9-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-9-14"><a href="#annotated-cell-9-14" aria-hidden="true" tabindex="-1"></a>    fig</span>
<span id="annotated-cell-9-15"><a href="#annotated-cell-9-15" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-9" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="6" data-code-annotation="1">Use string interpolation <code>$()</code> to insert station ID and name into the plot title</span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="7" data-code-annotation="2">Apply unit converter to display rainfall in inches instead of deca-inches</span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="10" data-code-annotation="3">Plot using <code>date</code> column to show precise timing of annual maximum events</span>
</dd>
<dt data-target-cell="annotated-cell-9" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-9" data-code-lines="11" data-code-annotation="4">Add hollow circles with transparent fill to emphasize individual data points</span>
</dd>
</dl>
</div>
</div>
</section>
</section>
<section id="gev-fitting-multiple-approaches" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="gev-fitting-multiple-approaches"><span class="header-section-number">1.2</span> GEV Fitting: Multiple Approaches</h2>
<p>Now is the time tocompare different approaches to fitting GEV distributions to understand how estimation methods affect our results.</p>
<section id="mle-with-extremes.jl-for-validation" class="level3" data-number="1.2.1">
<h3 data-number="1.2.1" class="anchored" data-anchor-id="mle-with-extremes.jl-for-validation"><span class="header-section-number">1.2.1</span> MLE with Extremes.jl For Validation</h3>
<p>First, fit a GEV distribution using maximum likelihood estimation (MLE) with <a href="https://jojal5.github.io/Extremes.jl/stable/"><code>Extremes.jl</code></a> for the validation:</p>
<div id="22" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-11"><pre class="sourceCode julia code-annotation-code code-with-copy code-annotated"><code class="sourceCode julia"><span id="annotated-cell-11-1"><a href="#annotated-cell-11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract clean data for fitting</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="1">1</button><span id="annotated-cell-11-2" class="code-annotation-target"><a href="#annotated-cell-11-2" aria-hidden="true" tabindex="-1"></a>y <span class="op">=</span> <span class="fu">collect</span>(<span class="fu">skipmissing</span>(<span class="fu">ustrip</span>.(u<span class="st">"inch"</span>, closest_rainfall.rainfall)))</span>
<span id="annotated-cell-11-3"><a href="#annotated-cell-11-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-11-4"><a href="#annotated-cell-11-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit GEV using maximum likelihood estimation (MLE)</span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="2">2</button><span id="annotated-cell-11-5" class="code-annotation-target"><a href="#annotated-cell-11-5" aria-hidden="true" tabindex="-1"></a>ext_fit <span class="op">=</span> <span class="fu">gevfit</span>(y)</span>
<span id="annotated-cell-11-6"><a href="#annotated-cell-11-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-11-7"><a href="#annotated-cell-11-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract parameters </span></span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="3">3</button><span id="annotated-cell-11-8" class="code-annotation-target"><a href="#annotated-cell-11-8" aria-hidden="true" tabindex="-1"></a>Œº_ext <span class="op">=</span> <span class="fu">location</span>(ext_fit)[<span class="fl">1</span>]</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="4">4</button><span id="annotated-cell-11-9" class="code-annotation-target"><a href="#annotated-cell-11-9" aria-hidden="true" tabindex="-1"></a>œÉ_ext <span class="op">=</span> <span class="fu">scale</span>(ext_fit)[<span class="fl">1</span>]</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-11" data-target-annotation="5">5</button><span id="annotated-cell-11-10" class="code-annotation-target"><a href="#annotated-cell-11-10" aria-hidden="true" tabindex="-1"></a>Œæ_ext <span class="op">=</span> <span class="fu">shape</span>(ext_fit)[<span class="fl">1</span>]</span>
<span id="annotated-cell-11-11"><a href="#annotated-cell-11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-11-12"><a href="#annotated-cell-11-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Display parameters in a DataFrame</span></span>
<span id="annotated-cell-11-13"><a href="#annotated-cell-11-13" aria-hidden="true" tabindex="-1"></a>params_extremes <span class="op">=</span> <span class="fu">DataFrame</span>(</span>
<span id="annotated-cell-11-14"><a href="#annotated-cell-11-14" aria-hidden="true" tabindex="-1"></a>    Parameter <span class="op">=</span> [<span class="st">"Location (Œº)"</span>, <span class="st">"Scale (œÉ)"</span>, <span class="st">"Shape (Œæ)"</span>],</span>
<span id="annotated-cell-11-15"><a href="#annotated-cell-11-15" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">=</span> [<span class="fu">round</span>(Œº_ext, digits <span class="op">=</span> <span class="fl">3</span>), <span class="fu">round</span>(œÉ_ext, digits <span class="op">=</span> <span class="fl">3</span>), <span class="fu">round</span>(Œæ_ext, digits <span class="op">=</span> <span class="fl">3</span>)],</span>
<span id="annotated-cell-11-16"><a href="#annotated-cell-11-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-11-17"><a href="#annotated-cell-11-17" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"Extremes.jl GEV parameters:"</span>)</span>
<span id="annotated-cell-11-18"><a href="#annotated-cell-11-18" aria-hidden="true" tabindex="-1"></a>params_extremes</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-11" data-target-annotation="1">1</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="2" data-code-annotation="1">Convert rainfall data to plain numbers, removing units and missing values</span>
</dd>
<dt data-target-cell="annotated-cell-11" data-target-annotation="2">2</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="5" data-code-annotation="2">Fit GEV distribution using maximum likelihood estimation (MLE)</span>
</dd>
<dt data-target-cell="annotated-cell-11" data-target-annotation="3">3</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="8" data-code-annotation="3">Extract location parameter (Œº) from the fitted model</span>
</dd>
<dt data-target-cell="annotated-cell-11" data-target-annotation="4">4</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="9" data-code-annotation="4">Extract scale parameter (œÉ) from the fitted model</span>
</dd>
<dt data-target-cell="annotated-cell-11" data-target-annotation="5">5</dt>
<dd>
<span data-code-cell="annotated-cell-11" data-code-lines="10" data-code-annotation="5">Extract shape parameter (Œæ) from the fitted model</span>
</dd>
</dl>
</div>
</div>
<div id="24" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-12"><pre class="sourceCode julia code-annotation-code code-with-copy code-annotated"><code class="sourceCode julia"><button class="code-annotation-anchor" data-target-cell="annotated-cell-12" data-target-annotation="6">6</button><span id="annotated-cell-12-1" class="code-annotation-target"><a href="#annotated-cell-12-1" aria-hidden="true" tabindex="-1"></a>extremes_dist <span class="op">=</span> <span class="fu">GeneralizedExtremeValue</span>(Œº_ext, œÉ_ext, Œæ_ext)</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-12" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-12" data-code-lines="1" data-code-annotation="6">Create a distribution object for further analysis and plotting</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>Distributions.GeneralizedExtremeValue{Float64}(Œº=3.7517276015345686, œÉ=1.4571087397080031, Œæ=0.2509577427772232)</code></pre>
</div>
</div>
</section>
<section id="mle-using-turning.jl-with-maximum_likelihood" class="level3" data-number="1.2.2">
<h3 data-number="1.2.2" class="anchored" data-anchor-id="mle-using-turning.jl-with-maximum_likelihood"><span class="header-section-number">1.2.2</span> MLE Using Turning.jl With <code>maximum_likelihood</code></h3>
<p>Secondly, implement maximum likelihood estimation (MLE) using <a href="https://github.com/TuringLang/Turing.jl/blob/main/ext/TuringOptimExt.jl"><code>Turing.jl</code></a> with [<code>maximum_likelihood</code>] workflow:</p>
<div id="26" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb8"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">gev_model</span>(y)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    Œº     <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, <span class="fl">10</span>)        <span class="co"># location prior</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    log_œÉ  <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0</span>, <span class="fl">10</span>)        <span class="co"># work on log-scale to keep œÉ&gt;0</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    Œæ     <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0.0</span>, <span class="fl">0.3</span>)     <span class="co"># shape prior (centered near Gumbel, allows ¬± tails)</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    œÉ <span class="op">=</span> <span class="fu">exp</span>(log_œÉ)</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    y <span class="op">.~</span> <span class="fu">GeneralizedExtremeValue</span>(Œº, œÉ, Œæ)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="30" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="annotated-cell-15"><pre class="sourceCode julia code-annotation-code code-with-copy code-annotated"><code class="sourceCode julia"><span id="annotated-cell-15-1"><a href="#annotated-cell-15-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract MLE parameters</span></span>
<span id="annotated-cell-15-2"><a href="#annotated-cell-15-2" aria-hidden="true" tabindex="-1"></a>Œº_map   <span class="op">=</span> map_res.values[<span class="op">:</span>Œº]</span>
<span id="annotated-cell-15-3"><a href="#annotated-cell-15-3" aria-hidden="true" tabindex="-1"></a>œÉ_map   <span class="op">=</span> <span class="fu">exp</span>(map_res.values[<span class="op">:</span>log_œÉ])</span>
<span id="annotated-cell-15-4"><a href="#annotated-cell-15-4" aria-hidden="true" tabindex="-1"></a>Œæ_map   <span class="op">=</span> map_res.values[<span class="op">:</span>Œæ]</span>
<span id="annotated-cell-15-5"><a href="#annotated-cell-15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-15-6"><a href="#annotated-cell-15-6" aria-hidden="true" tabindex="-1"></a>params_turing_map <span class="op">=</span> <span class="fu">DataFrame</span>(</span>
<span id="annotated-cell-15-7"><a href="#annotated-cell-15-7" aria-hidden="true" tabindex="-1"></a>    Parameter <span class="op">=</span> [<span class="st">"Location (Œº)"</span>, <span class="st">"Scale (œÉ)"</span>, <span class="st">"Shape (Œæ)"</span>],</span>
<span id="annotated-cell-15-8"><a href="#annotated-cell-15-8" aria-hidden="true" tabindex="-1"></a>    Value <span class="op">=</span> [<span class="fu">round</span>(Œº_map, digits<span class="op">=</span><span class="fl">3</span>), <span class="fu">round</span>(œÉ_map, digits<span class="op">=</span><span class="fl">3</span>), <span class="fu">round</span>(Œæ_map, digits<span class="op">=</span><span class="fl">3</span>)],</span>
<span id="annotated-cell-15-9"><a href="#annotated-cell-15-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="annotated-cell-15-10"><a href="#annotated-cell-15-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="annotated-cell-15-11"><a href="#annotated-cell-15-11" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"Turing.jl GEV parameters (MLE):"</span>)</span>
<button class="code-annotation-anchor" data-target-cell="annotated-cell-15" data-target-annotation="6">6</button><span id="annotated-cell-15-12" class="code-annotation-target"><a href="#annotated-cell-15-12" aria-hidden="true" tabindex="-1"></a>params_turing_map</span><div class="code-annotation-gutter-bg"></div><div class="code-annotation-gutter"></div></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-annotation">
<dl class="code-annotation-container-hidden code-annotation-container-grid">
<dt data-target-cell="annotated-cell-15" data-target-annotation="6">6</dt>
<dd>
<span data-code-cell="annotated-cell-15" data-code-lines="12" data-code-annotation="6">Create a distribution object for further analysis and plotting</span>
</dd>
</dl>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Turing.jl GEV parameters (MLE):</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div><div style="float: left;"><span>3√ó2 DataFrame</span></div><div style="clear: both;"></div></div><div class="data-frame" style="overflow-x: scroll;">
<table class="data-frame caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;">Row</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Parameter</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Value</th>
</tr>
<tr class="subheader headerLastRow even">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1</td>
<td style="text-align: left;">Location (Œº)</td>
<td style="text-align: right;">3.752</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">2</td>
<td style="text-align: left;">Scale (œÉ)</td>
<td style="text-align: right;">1.457</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">3</td>
<td style="text-align: left;">Shape (Œæ)</td>
<td style="text-align: right;">0.251</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="build-a-distribution-object-and-benchmark-vs-extremes.jl" class="level3" data-number="1.2.3">
<h3 data-number="1.2.3" class="anchored" data-anchor-id="build-a-distribution-object-and-benchmark-vs-extremes.jl"><span class="header-section-number">1.2.3</span> Build a Distribution Object And Benchmark vs Extremes.jl</h3>
<p>Check the <code>MLE</code> from Turning.jl and results from <code>Extreme.jl</code>.</p>
<div id="32" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb10"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>turing_map_dist <span class="op">=</span> <span class="fu">GeneralizedExtremeValue</span>(Œº_map, œÉ_map, Œæ_map)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Side-by-side parameter comparison </span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>params_compare <span class="op">=</span> <span class="fu">DataFrame</span>(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    Method <span class="op">=</span> [<span class="st">"Extremes MLE"</span>, <span class="st">"Turing MLE optimized"</span>],</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>     Œº <span class="op">=</span> [<span class="fu">round</span>(Œº_ext, digits<span class="op">=</span><span class="fl">3</span>), <span class="fu">round</span>(Œº_map, digits<span class="op">=</span><span class="fl">3</span>)],</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>     œÉ <span class="op">=</span> [<span class="fu">round</span>(œÉ_ext, digits<span class="op">=</span><span class="fl">3</span>), <span class="fu">round</span>(œÉ_map, digits<span class="op">=</span><span class="fl">3</span>)],</span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>     Œæ <span class="op">=</span> [<span class="fu">round</span>(Œæ_ext, digits<span class="op">=</span><span class="fl">3</span>), <span class="fu">round</span>(Œæ_map, digits<span class="op">=</span><span class="fl">3</span>)],</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="34" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb11"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>params_compare</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div><div style="float: left;"><span>2√ó4 DataFrame</span></div><div style="clear: both;"></div></div><div class="data-frame" style="overflow-x: scroll;">
<table class="data-frame caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;">Row</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Method</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Œº</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">œÉ</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Œæ</th>
</tr>
<tr class="subheader headerLastRow even">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1</td>
<td style="text-align: left;">Extremes MLE</td>
<td style="text-align: right;">3.752</td>
<td style="text-align: right;">1.457</td>
<td style="text-align: right;">0.251</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">2</td>
<td style="text-align: left;">Turing MLE optimized</td>
<td style="text-align: right;">3.752</td>
<td style="text-align: right;">1.457</td>
<td style="text-align: right;">0.251</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
</section>
<section id="implement-bayesian-gev-inference-using-mcmc" class="level3" data-number="1.2.4">
<h3 data-number="1.2.4" class="anchored" data-anchor-id="implement-bayesian-gev-inference-using-mcmc"><span class="header-section-number">1.2.4</span> Implement Bayesian GEV Inference using MCMC</h3>
<p>Now I implemented the Bayesian GEV predition using MCMC. The Houston Airport(IAH) experiences annual rain depth from 1.5 to 5.0 inches mostly. When the typhoon comes, the rain depth will increase. The scale between 0.07 and 0.5 would help to control the spread of the curve. The rain depth increase slowly and change slightly in the near future so the <code>$\sigma$</code> should not be set large. The shape prior help to control the shape at the right side of the predition line.</p>
<div id="36" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb12"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">gev_model_houston</span>(y)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    Œº      <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">5.0</span>, <span class="fl">1.5</span>)                                      <span class="co"># location prior (inches)</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    log_œÉ  <span class="op">~</span> <span class="fu">Normal</span>(<span class="fu">log</span>(<span class="fl">1.2</span>), <span class="fl">0.5</span>)                                 <span class="co"># log-scale prior for œÉ&gt;0</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>    Œæ      <span class="op">~</span> <span class="fu">truncated</span>(<span class="fu">Normal</span>(<span class="fl">0.1</span>, <span class="fl">0.15</span>), <span class="op">-</span><span class="fl">0.2</span>, <span class="fl">0.5</span>)               <span class="co"># shape prior, stabilized range</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    œÉ <span class="op">=</span> <span class="fu">exp</span>(log_œÉ)</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>    y <span class="op">.~</span> <span class="fu">GeneralizedExtremeValue</span>(Œº, œÉ, Œæ)                          <span class="co"># vectorized likelihood</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="bu">Random</span>.<span class="fu">seed!</span>(<span class="fl">256</span>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> <span class="fu">gev_model_houston</span>(y)</span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="co"># 4 chains √ó 2000 draws (1000 warmup)</span></span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>nchains  <span class="op">=</span> <span class="fl">4</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>ndraws   <span class="op">=</span> <span class="fl">2000</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>nwarmup  <span class="op">=</span> <span class="fl">1000</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>chain <span class="op">=</span> <span class="fu">sample</span>(</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>    model, <span class="fu">NUTS</span>(), <span class="fu">MCMCSerial</span>(), ndraws, nchains;</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>               num_warmup <span class="op">=</span> nwarmup, discard_adapt <span class="op">=</span> <span class="cn">true</span>, progress <span class="op">=</span> <span class="cn">false</span>    <span class="co">#keep your flags</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior means</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>Œº_bayes  <span class="op">=</span> <span class="fu">mean</span>(chain[<span class="op">:</span>Œº])</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>œÉ_bayes  <span class="op">=</span> <span class="fu">mean</span>(<span class="fu">exp</span>.(chain[<span class="op">:</span>log_œÉ]))</span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>Œæ_bayes  <span class="op">=</span> <span class="fu">mean</span>(chain[<span class="op">:</span>Œæ])</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Build a representative posterior-mean distribution</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>bayes_dist <span class="op">=</span> <span class="fu">GeneralizedExtremeValue</span>(Œº_bayes, œÉ_bayes, Œæ_bayes)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="38" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb13"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Convert Turing Chains -&gt; ArviZ InferenceData (same as lab)</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>posterior_idata <span class="op">=</span> ArviZ.<span class="fu">from_mcmcchains</span>(chain)</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Print summary with RÃÇ and effective sample sizes (bulk/tail)</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>ArviZ.<span class="fu">summarize</span>(posterior_idata)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a><span class="co"># plot_trace_diagnostics(posterior_idata, "Primary Station:")</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a><span class="co"># fig_densities_primary = plot_marginal_densities(posterior_idata, "Primary Station:")</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<ul>
<li><span class="math inline">\(\hat{R}\)</span> values close to 1.0 (indicates chains have converged to same distribution)</li>
<li>Effective sample sizes (<code>ess_tail</code> and <code>ess_bulk</code>) that are reasonably large (as close to the total number of samples as possible)</li>
</ul>
<div id="40" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb14"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior draws (flatten across chains/iterations)</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>Œº_samps <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">Array</span>(chain[<span class="op">:</span>Œº]))</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>œÉ_samps <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">exp</span>.(<span class="fu">Array</span>(chain[<span class="op">:</span>log_œÉ])))</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>Œæ_samps <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">Array</span>(chain[<span class="op">:</span>Œæ]))</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>q <span class="op">=</span> (x, p) <span class="op">-&gt;</span> <span class="fu">quantile</span>(x, p)</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>params_cmp <span class="op">=</span> <span class="fu">DataFrame</span>(</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    Parameter  <span class="op">=</span> [<span class="st">"Œº"</span>,<span class="st">"œÉ"</span>,<span class="st">"Œæ"</span>],</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>    MLE        <span class="op">=</span> [Œº_ext, œÉ_ext, Œæ_ext],</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    Post_mean  <span class="op">=</span> [<span class="fu">mean</span>(Œº_samps), <span class="fu">mean</span>(œÉ_samps), <span class="fu">mean</span>(Œæ_samps)],</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    Post_low   <span class="op">=</span> [<span class="fu">q</span>(Œº_samps, <span class="fl">0.025</span>), <span class="fu">q</span>(œÉ_samps, <span class="fl">0.025</span>), <span class="fu">q</span>(Œæ_samps, <span class="fl">0.025</span>)],</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>    Post_high  <span class="op">=</span> [<span class="fu">q</span>(Œº_samps, <span class="fl">0.975</span>), <span class="fu">q</span>(œÉ_samps, <span class="fl">0.975</span>), <span class="fu">q</span>(Œæ_samps, <span class="fl">0.975</span>)]</span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Parameter comparison (MLE vs posterior, 95% CI):"</span>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a><span class="fu">show</span>(params_cmp, allcols <span class="op">=</span> <span class="cn">true</span>)   <span class="co"># avoid unsupported kwargs</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co"># --- Return levels: MLE vs posterior (95% CI) ---</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="fu">rl</span>(p, Œº, œÉ, Œæ) <span class="op">=</span> <span class="fu">quantile</span>(<span class="fu">GeneralizedExtremeValue</span>(Œº, œÉ, Œæ), p)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>Ts <span class="op">=</span> [<span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">25</span>, <span class="fl">50</span>, <span class="fl">100</span>]</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>ps <span class="op">=</span> <span class="fl">1</span> <span class="op">.-</span> <span class="fl">1</span> <span class="op">./</span> Ts</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a><span class="co"># MLE point return levels</span></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>rl_mle <span class="op">=</span> [<span class="fu">rl</span>(p, Œº_ext, œÉ_ext, Œæ_ext) for p <span class="kw">in</span> ps]</span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior return levels (sample-wise)</span></span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="fu">length</span>(Œº_samps)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>J <span class="op">=</span> <span class="fu">length</span>(Ts)</span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>rl_mat <span class="op">=</span> <span class="fu">Array</span><span class="dt">{Float64}</span>(<span class="cn">undef</span>, n, J)</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a><span class="pp">@inbounds</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>    Œºi, œÉi, Œæi <span class="op">=</span> Œº_samps[i], œÉ_samps[i], Œæ_samps[i]</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>J</span>
<span id="cb14-35"><a href="#cb14-35" aria-hidden="true" tabindex="-1"></a>        rl_mat[i, j] <span class="op">=</span> <span class="fu">rl</span>(ps[j], Œºi, œÉi, Œæi)</span>
<span id="cb14-36"><a href="#cb14-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb14-37"><a href="#cb14-37" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb14-38"><a href="#cb14-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-39"><a href="#cb14-39" aria-hidden="true" tabindex="-1"></a>rl_mean <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">mean</span>(rl_mat; dims <span class="op">=</span> <span class="fl">1</span>))</span>
<span id="cb14-40"><a href="#cb14-40" aria-hidden="true" tabindex="-1"></a>rl_low  <span class="op">=</span> [<span class="fu">quantile</span>(<span class="fu">view</span>(rl_mat, <span class="op">:</span>, j), <span class="fl">0.025</span>) for j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>J]</span>
<span id="cb14-41"><a href="#cb14-41" aria-hidden="true" tabindex="-1"></a>rl_high <span class="op">=</span> [<span class="fu">quantile</span>(<span class="fu">view</span>(rl_mat, <span class="op">:</span>, j), <span class="fl">0.975</span>) for j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>J]</span>
<span id="cb14-42"><a href="#cb14-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-43"><a href="#cb14-43" aria-hidden="true" tabindex="-1"></a>rl_tbl <span class="op">=</span> <span class="fu">DataFrame</span>(</span>
<span id="cb14-44"><a href="#cb14-44" aria-hidden="true" tabindex="-1"></a>    T_years         <span class="op">=</span> Ts,</span>
<span id="cb14-45"><a href="#cb14-45" aria-hidden="true" tabindex="-1"></a>    MLE             <span class="op">=</span> rl_mle,</span>
<span id="cb14-46"><a href="#cb14-46" aria-hidden="true" tabindex="-1"></a>    Posterior_mean  <span class="op">=</span> rl_mean,</span>
<span id="cb14-47"><a href="#cb14-47" aria-hidden="true" tabindex="-1"></a>    Posterior_low   <span class="op">=</span> rl_low,</span>
<span id="cb14-48"><a href="#cb14-48" aria-hidden="true" tabindex="-1"></a>    Posterior_high  <span class="op">=</span> rl_high</span>
<span id="cb14-49"><a href="#cb14-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb14-50"><a href="#cb14-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-51"><a href="#cb14-51" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"</span><span class="sc">\n</span><span class="st">Return levels (inches): MLE vs posterior (95% CI)"</span>)</span>
<span id="cb14-52"><a href="#cb14-52" aria-hidden="true" tabindex="-1"></a><span class="fu">show</span>(rl_tbl, allcols <span class="op">=</span> <span class="cn">true</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<div class="ansi-escaped-output">
<pre>Parameter comparison (MLE vs posterior, 95% CI):
<span class="ansi-bold">3√ó5 DataFrame</span>
<span class="ansi-bold"> Row </span>‚îÇ<span class="ansi-bold"> Parameter </span><span class="ansi-bold"> MLE      </span><span class="ansi-bold"> Post_mean </span><span class="ansi-bold"> Post_low  </span><span class="ansi-bold"> Post_high </span>
     ‚îÇ<span class="ansi-bright-black-fg"> String    </span><span class="ansi-bright-black-fg"> Float64  </span><span class="ansi-bright-black-fg"> Float64   </span><span class="ansi-bright-black-fg"> Float64   </span><span class="ansi-bright-black-fg"> Float64   </span>
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   1 ‚îÇ Œº          3.75173    3.81794   3.3657      4.32114
   2 ‚îÇ œÉ          1.45711    1.53368   1.18266     1.97954
   3 ‚îÇ Œæ          0.250958   0.191364  0.0205682   0.378533
Return levels (inches): MLE vs posterior (95% CI)
<span class="ansi-bold">5√ó5 DataFrame</span>
<span class="ansi-bold"> Row </span>‚îÇ<span class="ansi-bold"> T_years </span><span class="ansi-bold"> MLE      </span><span class="ansi-bold"> Posterior_mean </span><span class="ansi-bold"> Posterior_low </span><span class="ansi-bold"> Posterior_high </span>
     ‚îÇ<span class="ansi-bright-black-fg"> Int64   </span><span class="ansi-bright-black-fg"> Float64  </span><span class="ansi-bright-black-fg"> Float64        </span><span class="ansi-bright-black-fg"> Float64       </span><span class="ansi-bright-black-fg"> Float64        </span>
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   1 ‚îÇ       5   6.40551         6.48788        5.58348         7.66314
   2 ‚îÇ      10   8.15864         8.15679        6.83055        10.0216
   3 ‚îÇ      25  10.9023         10.6776         8.49687        14.1487
   4 ‚îÇ      50  13.4038         12.9118         9.77791        18.3236
   5 ‚îÇ     100  16.3643         15.5051        11.0986         23.7709</pre>
</div>
</div>
</div>
<p>The table summarized the result about the parameter comparison for MLE and Bayesian posterior with 95% CI. It also reflected the return level difference that are predicted by MLE and Bayesian posterior with 85% CI.</p>
</section>
</section>
<section id="compare-all-three-methods" class="level2" data-number="1.3">
<h2 data-number="1.3" class="anchored" data-anchor-id="compare-all-three-methods"><span class="header-section-number">1.3</span> Compare All Three Methods</h2>
<p>Let me combine all the results together and show them in table form for visualizaiton.</p>
<div id="42" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb15"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>params_compare2 <span class="op">=</span> <span class="fu">DataFrame</span>(</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    Method <span class="op">=</span> [<span class="st">"Extremes MLE"</span>, <span class="st">"Turing MAP"</span>, <span class="st">"Bayesian MCMC (mean)"</span>],</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>    Œº <span class="op">=</span> [Œº_ext,  Œº_map,  Œº_bayes],</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    œÉ <span class="op">=</span> [œÉ_ext,  œÉ_map,  œÉ_bayes],</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    Œæ <span class="op">=</span> [Œæ_ext,  Œæ_map,  Œæ_bayes],</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"Parameter comparison:"</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>params_compare2</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>return_periods <span class="op">=</span> [<span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">25</span>, <span class="fl">50</span>, <span class="fl">100</span>]</span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-12"><a href="#cb15-12" aria-hidden="true" tabindex="-1"></a>ext_levels   <span class="op">=</span> [<span class="fu">quantile</span>(extremes_dist,   <span class="fl">1</span> <span class="op">-</span> <span class="fl">1</span><span class="op">/</span>T) for T <span class="kw">in</span> return_periods]</span>
<span id="cb15-13"><a href="#cb15-13" aria-hidden="true" tabindex="-1"></a>map_levels   <span class="op">=</span> [<span class="fu">quantile</span>(turing_map_dist, <span class="fl">1</span> <span class="op">-</span> <span class="fl">1</span><span class="op">/</span>T) for T <span class="kw">in</span> return_periods]</span>
<span id="cb15-14"><a href="#cb15-14" aria-hidden="true" tabindex="-1"></a>bayes_levels <span class="op">=</span> [<span class="fu">quantile</span>(bayes_dist,      <span class="fl">1</span> <span class="op">-</span> <span class="fl">1</span><span class="op">/</span>T) for T <span class="kw">in</span> return_periods]</span>
<span id="cb15-15"><a href="#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="#cb15-16" aria-hidden="true" tabindex="-1"></a>return_levels_compare <span class="op">=</span> <span class="fu">DataFrame</span>(</span>
<span id="cb15-17"><a href="#cb15-17" aria-hidden="true" tabindex="-1"></a>    T_years       <span class="op">=</span> return_periods,</span>
<span id="cb15-18"><a href="#cb15-18" aria-hidden="true" tabindex="-1"></a>    Extremes_MLE  <span class="op">=</span> <span class="fu">round</span>.(ext_levels,   digits<span class="op">=</span><span class="fl">3</span>),</span>
<span id="cb15-19"><a href="#cb15-19" aria-hidden="true" tabindex="-1"></a>    Turing_MAP    <span class="op">=</span> <span class="fu">round</span>.(map_levels,   digits<span class="op">=</span><span class="fl">3</span>),</span>
<span id="cb15-20"><a href="#cb15-20" aria-hidden="true" tabindex="-1"></a>    Bayesian_MCMC <span class="op">=</span> <span class="fu">round</span>.(bayes_levels, digits<span class="op">=</span><span class="fl">3</span>),</span>
<span id="cb15-21"><a href="#cb15-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb15-22"><a href="#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"Return level comparison (inches):"</span>)</span>
<span id="cb15-23"><a href="#cb15-23" aria-hidden="true" tabindex="-1"></a>return_levels_compare</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Parameter comparison:
Return level comparison (inches):</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div><div style="float: left;"><span>5√ó4 DataFrame</span></div><div style="clear: both;"></div></div><div class="data-frame" style="overflow-x: scroll;">
<table class="data-frame caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;">Row</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">T_years</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Extremes_MLE</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Turing_MAP</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Bayesian_MCMC</th>
</tr>
<tr class="subheader headerLastRow even">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1</td>
<td style="text-align: right;">5</td>
<td style="text-align: right;">6.406</td>
<td style="text-align: right;">6.405</td>
<td style="text-align: right;">6.483</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">2</td>
<td style="text-align: right;">10</td>
<td style="text-align: right;">8.159</td>
<td style="text-align: right;">8.159</td>
<td style="text-align: right;">8.132</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">3</td>
<td style="text-align: right;">25</td>
<td style="text-align: right;">10.902</td>
<td style="text-align: right;">10.902</td>
<td style="text-align: right;">10.584</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">4</td>
<td style="text-align: right;">50</td>
<td style="text-align: right;">13.404</td>
<td style="text-align: right;">13.404</td>
<td style="text-align: right;">12.714</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">5</td>
<td style="text-align: right;">100</td>
<td style="text-align: right;">16.364</td>
<td style="text-align: right;">16.364</td>
<td style="text-align: right;">15.131</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Now let me combine all GEV fitting prediction line together, which included the MLE line predicted by <code>Turing.jl</code>, extreme GEV line from <code>Extremes.jl</code>, and Bayesian GEV with <code>Turning.jl</code> using MCMC.</p>
<div id="44" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb17"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plot_all_three_with_empirical</span>(station_data, extremes_dist, turing_map_dist, bayes_dist, station_info)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size <span class="op">=</span> (<span class="fl">900</span>, <span class="fl">520</span>))</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>];</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>        xlabel <span class="op">=</span> <span class="st">"Return Period (years)"</span>,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>        ylabel <span class="op">=</span> <span class="st">"Return Level (inches)"</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>        title  <span class="op">=</span> <span class="st">"GEV Fits vs Empirical</span><span class="sc">\n$</span>(station_info.noaa_id)<span class="st">: </span><span class="sc">$</span>(station_info.name)<span class="st">"</span>,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>        xscale <span class="op">=</span> log10,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>        dim2_conversion <span class="op">=</span> rainfall_conversion,</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Smooth theoretical curves ---</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>    T_smooth <span class="op">=</span> <span class="fl">10</span> <span class="op">.^</span> <span class="fu">range</span>(<span class="fu">log10</span>(<span class="fl">1.1</span>), <span class="fu">log10</span>(<span class="fl">250</span>), length <span class="op">=</span> <span class="fl">200</span>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a>    ext_levels   <span class="op">=</span> [<span class="fu">quantile</span>(extremes_dist,   <span class="fl">1</span> <span class="op">-</span> <span class="fl">1</span><span class="op">/</span>T) for T <span class="kw">in</span> T_smooth] <span class="op">.*</span> u<span class="st">"inch"</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>    map_levels   <span class="op">=</span> [<span class="fu">quantile</span>(turing_map_dist, <span class="fl">1</span> <span class="op">-</span> <span class="fl">1</span><span class="op">/</span>T) for T <span class="kw">in</span> T_smooth] <span class="op">.*</span> u<span class="st">"inch"</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>    bayes_levels <span class="op">=</span> [<span class="fu">quantile</span>(bayes_dist,      <span class="fl">1</span> <span class="op">-</span> <span class="fl">1</span><span class="op">/</span>T) for T <span class="kw">in</span> T_smooth] <span class="op">.*</span> u<span class="st">"inch"</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines!</span>(ax, T_smooth, ext_levels;   color <span class="op">=</span> <span class="op">:</span>blue,  linewidth <span class="op">=</span> <span class="fl">2.0</span>, label <span class="op">=</span> <span class="st">"Extremes MLE"</span>)</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines!</span>(ax, T_smooth, map_levels;   color <span class="op">=</span> <span class="op">:</span>red,   linewidth <span class="op">=</span> <span class="fl">2.0</span>, linestyle <span class="op">=</span> <span class="op">:</span>dash, label <span class="op">=</span> <span class="st">"Turing MLE"</span>)</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines!</span>(ax, T_smooth, bayes_levels; color <span class="op">=</span> <span class="op">:</span>green, linewidth <span class="op">=</span> <span class="fl">2.0</span>, linestyle <span class="op">=</span> <span class="op">:</span>dot,  label <span class="op">=</span> <span class="st">"Bayesian MCMC (mean)"</span>)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a>    <span class="co"># --- Empirical Weibull plotting positions ---</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>    vals <span class="op">=</span> <span class="fu">collect</span>(<span class="fu">skipmissing</span>(station_data.rainfall))</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> !<span class="fu">isempty</span>(vals)</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sort!</span>(vals)</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>        n <span class="op">=</span> <span class="fu">length</span>(vals)</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>        emp_periods <span class="op">=</span> [(n <span class="op">+</span> <span class="fl">1</span>) <span class="op">/</span> (n <span class="op">+</span> <span class="fl">1</span> <span class="op">-</span> i) for i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n] <span class="co"># T(i) = (n+1)/(n+1 - i)</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>        emp_levels  <span class="op">=</span> (vals isa <span class="dt">Vector</span>{<span class="op">&lt;:</span><span class="dt">Quantity</span>}) ? vals <span class="op">:</span> vals <span class="op">.*</span> u<span class="st">"inch"</span></span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scatter!</span>(ax, emp_periods, emp_levels; color <span class="op">=</span> <span class="op">:</span>black, markersize <span class="op">=</span> <span class="fl">8</span>,</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a>                 strokewidth <span class="op">=</span> <span class="fl">1.5</span>, marker <span class="op">=</span> <span class="op">:</span>circle, label <span class="op">=</span> <span class="st">"Observed (Weibull)"</span>)</span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a>    ax.xticks <span class="op">=</span> [<span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">25</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">250</span>]</span>
<span id="cb17-33"><a href="#cb17-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axislegend</span>(ax, position <span class="op">=</span> <span class="op">:</span>rb)</span>
<span id="cb17-34"><a href="#cb17-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig</span>
<span id="cb17-35"><a href="#cb17-35" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb17-36"><a href="#cb17-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-37"><a href="#cb17-37" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_all_three_with_empirical</span>(closest_rainfall, extremes_dist, turing_map_dist, bayes_dist, closest_station)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="assignment-1_files/figure-html/cell-23-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="calculate-50-year-and-100-year-return-period-estimation" class="level2" data-number="1.4">
<h2 data-number="1.4" class="anchored" data-anchor-id="calculate-50-year-and-100-year-return-period-estimation"><span class="header-section-number">1.4</span> Calculate 50-year and 100-year Return Period Estimation</h2>
<div id="46" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb18"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="fu">rl</span>(p, Œº, œÉ, Œæ) <span class="op">=</span> <span class="fu">quantile</span>(<span class="fu">GeneralizedExtremeValue</span>(Œº, œÉ, Œæ), p)</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior draws (flatten chains)</span></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>Œº_samps <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">Array</span>(chain[<span class="op">:</span>Œº]))</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>œÉ_samps <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">exp</span>.(<span class="fu">Array</span>(chain[<span class="op">:</span>log_œÉ])))</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>Œæ_samps <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">Array</span>(chain[<span class="op">:</span>Œæ]))</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Return-period grid (Lab 3 synthetic-experiment style ticks)</span></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>Ts_grid <span class="op">=</span> [<span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">25</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">200</span>]</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>ps_grid <span class="op">=</span> <span class="fl">1</span> <span class="op">.-</span> <span class="fl">1</span> <span class="op">./</span> Ts_grid</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior return levels across the grid</span></span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> <span class="fu">length</span>(Œº_samps); J <span class="op">=</span> <span class="fu">length</span>(Ts_grid)</span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>rl_mat <span class="op">=</span> <span class="fu">Matrix</span><span class="dt">{Float64}</span>(<span class="cn">undef</span>, n, J)</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a><span class="pp">@inbounds</span> <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    Œºi <span class="op">=</span> Œº_samps[i]; œÉi <span class="op">=</span> œÉ_samps[i]; Œæi <span class="op">=</span> Œæ_samps[i]</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>J</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>        rl_mat[i, j] <span class="op">=</span> <span class="fu">rl</span>(ps_grid[j], Œºi, œÉi, Œæi)</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>rl_post_mean <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">mean</span>(rl_mat; dims <span class="op">=</span> <span class="fl">1</span>))</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>rl_post_low  <span class="op">=</span> [<span class="fu">quantile</span>(<span class="fu">view</span>(rl_mat, <span class="op">:</span>, j), <span class="fl">0.025</span>) for j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>J]</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>rl_post_high <span class="op">=</span> [<span class="fu">quantile</span>(<span class="fu">view</span>(rl_mat, <span class="op">:</span>, j), <span class="fl">0.975</span>) for j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>J]</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a><span class="co"># MLE curve over the same grid</span></span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>rl_mle_curve <span class="op">=</span> [<span class="fu">rl</span>(p, Œº_ext, œÉ_ext, Œæ_ext) for p <span class="kw">in</span> ps_grid]</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> <span class="fu">Figure</span>(size <span class="op">=</span> (<span class="fl">720</span>, <span class="fl">440</span>))</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a>ax  <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>];</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a>    xscale <span class="op">=</span> log10,</span>
<span id="cb18-33"><a href="#cb18-33" aria-hidden="true" tabindex="-1"></a>    xlabel <span class="op">=</span> <span class="st">"Return period T (years)"</span>,</span>
<span id="cb18-34"><a href="#cb18-34" aria-hidden="true" tabindex="-1"></a>    ylabel <span class="op">=</span> <span class="st">"Return level (inches)"</span>,</span>
<span id="cb18-35"><a href="#cb18-35" aria-hidden="true" tabindex="-1"></a>    xticks <span class="op">=</span> (Ts_grid, <span class="fu">string</span>.(Ts_grid)),</span>
<span id="cb18-36"><a href="#cb18-36" aria-hidden="true" tabindex="-1"></a>    title  <span class="op">=</span> <span class="st">"Return level vs Return period"</span></span>
<span id="cb18-37"><a href="#cb18-37" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-38"><a href="#cb18-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-39"><a href="#cb18-39" aria-hidden="true" tabindex="-1"></a><span class="co"># 95% posterior credible band</span></span>
<span id="cb18-40"><a href="#cb18-40" aria-hidden="true" tabindex="-1"></a><span class="fu">band!</span>(ax, Ts_grid, rl_post_low, rl_post_high, label <span class="op">=</span> <span class="st">"Posterior 95% CI"</span>)</span>
<span id="cb18-41"><a href="#cb18-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-42"><a href="#cb18-42" aria-hidden="true" tabindex="-1"></a><span class="co"># Posterior mean curve</span></span>
<span id="cb18-43"><a href="#cb18-43" aria-hidden="true" tabindex="-1"></a><span class="fu">lines!</span>(ax, Ts_grid, rl_post_mean, linewidth <span class="op">=</span> <span class="fl">2</span>, label <span class="op">=</span> <span class="st">"Posterior mean"</span>)</span>
<span id="cb18-44"><a href="#cb18-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-45"><a href="#cb18-45" aria-hidden="true" tabindex="-1"></a><span class="co"># MLE curve</span></span>
<span id="cb18-46"><a href="#cb18-46" aria-hidden="true" tabindex="-1"></a><span class="fu">lines!</span>(ax, Ts_grid, rl_mle_curve, linewidth <span class="op">=</span> <span class="fl">2</span>, linestyle <span class="op">=</span> <span class="op">:</span>dash, label <span class="op">=</span> <span class="st">"MLE"</span>)</span>
<span id="cb18-47"><a href="#cb18-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-48"><a href="#cb18-48" aria-hidden="true" tabindex="-1"></a><span class="co"># Highlight T = 50 and 100 (posterior mean and MLE)</span></span>
<span id="cb18-49"><a href="#cb18-49" aria-hidden="true" tabindex="-1"></a>i50  <span class="op">=</span> <span class="fu">findfirst</span>(<span class="op">==</span>(<span class="fl">50</span>), Ts_grid)</span>
<span id="cb18-50"><a href="#cb18-50" aria-hidden="true" tabindex="-1"></a>i100 <span class="op">=</span> <span class="fu">findfirst</span>(<span class="op">==</span>(<span class="fl">100</span>), Ts_grid)</span>
<span id="cb18-51"><a href="#cb18-51" aria-hidden="true" tabindex="-1"></a><span class="fu">scatter!</span>(ax, [Ts_grid[i50], Ts_grid[i100]],</span>
<span id="cb18-52"><a href="#cb18-52" aria-hidden="true" tabindex="-1"></a>              [rl_post_mean[i50], rl_post_mean[i100]];</span>
<span id="cb18-53"><a href="#cb18-53" aria-hidden="true" tabindex="-1"></a>              markersize <span class="op">=</span> <span class="fl">10</span>, label <span class="op">=</span> <span class="st">"Posterior @ 50,100"</span>)</span>
<span id="cb18-54"><a href="#cb18-54" aria-hidden="true" tabindex="-1"></a><span class="fu">scatter!</span>(ax, [Ts_grid[i50], Ts_grid[i100]],</span>
<span id="cb18-55"><a href="#cb18-55" aria-hidden="true" tabindex="-1"></a>              [rl_mle_curve[i50], rl_mle_curve[i100]];</span>
<span id="cb18-56"><a href="#cb18-56" aria-hidden="true" tabindex="-1"></a>              marker <span class="op">=</span> <span class="op">:</span>diamond, markersize <span class="op">=</span> <span class="fl">10</span>, label <span class="op">=</span> <span class="st">"MLE @ 50,100"</span>)</span>
<span id="cb18-57"><a href="#cb18-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-58"><a href="#cb18-58" aria-hidden="true" tabindex="-1"></a><span class="fu">axislegend</span>(ax, position <span class="op">=</span> <span class="op">:</span>lt)</span>
<span id="cb18-59"><a href="#cb18-59" aria-hidden="true" tabindex="-1"></a>fig</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="assignment-1_files/figure-html/cell-24-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="48" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb19"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Highlight T = 50 and 100 (posterior mean and MLE)</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>i50  <span class="op">=</span> <span class="fu">findfirst</span>(<span class="op">==</span>(<span class="fl">50</span>), Ts_grid)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>i100 <span class="op">=</span> <span class="fu">findfirst</span>(<span class="op">==</span>(<span class="fl">100</span>), Ts_grid)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Two posterior value</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>rl50  <span class="op">=</span> rl_mat[<span class="op">:</span>, i50]</span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>rl100 <span class="op">=</span> rl_mat[<span class="op">:</span>, i100]</span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a><span class="co"># MLE value</span></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>mle50  <span class="op">=</span> rl_mle_curve[i50]</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>mle100 <span class="op">=</span> rl_mle_curve[i100]</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot histogram</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>fig <span class="op">=</span> <span class="fu">Figure</span>(size <span class="op">=</span> (<span class="fl">900</span>, <span class="fl">360</span>))</span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>ax1 <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>],</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>    xlabel <span class="op">=</span> <span class="st">"50-year Return Level (inches)"</span>,</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>    ylabel <span class="op">=</span> <span class="st">"Frequency"</span>,</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>    title  <span class="op">=</span> <span class="st">"T = 50 years"</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a><span class="fu">hist!</span>(ax1, rl50; bins <span class="op">=</span> <span class="fl">30</span>)</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a><span class="fu">vlines!</span>(ax1, [<span class="fu">mean</span>(rl50)];  linewidth <span class="op">=</span> <span class="fl">2</span>, label <span class="op">=</span> <span class="st">"Posterior mean"</span>)</span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a><span class="fu">vlines!</span>(ax1, [mle50];       linewidth <span class="op">=</span> <span class="fl">2</span>, linestyle <span class="op">=</span> <span class="op">:</span>dash, label <span class="op">=</span> <span class="st">"MLE"</span>)</span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a><span class="fu">axislegend</span>(ax1, position <span class="op">=</span> <span class="op">:</span>rt)</span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>ax2 <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">2</span>],</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>    xlabel <span class="op">=</span> <span class="st">"100-year Return Level (inches)"</span>,</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    ylabel <span class="op">=</span> <span class="st">"Frequency"</span>,</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a>    title  <span class="op">=</span> <span class="st">"T = 100 years"</span></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a><span class="fu">hist!</span>(ax2, rl100; bins <span class="op">=</span> <span class="fl">30</span>)</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a><span class="fu">vlines!</span>(ax2, [<span class="fu">mean</span>(rl100)]; linewidth <span class="op">=</span> <span class="fl">2</span>, label <span class="op">=</span> <span class="st">"Posterior mean"</span>)</span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a><span class="fu">vlines!</span>(ax2, [mle100];      linewidth <span class="op">=</span> <span class="fl">2</span>, linestyle <span class="op">=</span> <span class="op">:</span>dash, label <span class="op">=</span> <span class="st">"MLE"</span>)</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a><span class="fu">axislegend</span>(ax2, position <span class="op">=</span> <span class="op">:</span>rt)</span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>fig</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="assignment-1_files/figure-html/cell-25-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Finished task one.</p>
</section>
</section>
<section id="task-2-multi-station-regional-analysis" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Task 2: Multi-station Regional Analysis</h1>
<section id="get-the-nearest-4-stations" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="get-the-nearest-4-stations"><span class="header-section-number">2.1</span> Get the Nearest 4 Stations</h2>
<p>Now is the time to check the precipitation trends for my selected station and its surrounding stations. First let me get the nearest 4 stations.</p>
<div id="50" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb20"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>my_station <span class="op">=</span> closest_station</span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>target_lon <span class="op">=</span> my_station.longitude</span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>target_lat <span class="op">=</span> my_station.latitude</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a>nearest_stations <span class="op">=</span> <span class="pp">@chain</span> stations <span class="cf">begin</span></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@filter</span>(stnid <span class="op">!=</span> <span class="fl">782</span>)  <span class="co"># exclude the primary itself</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@mutate</span>(distance_km <span class="op">=</span> <span class="fu">calc_distance</span>(longitude, latitude, !!target_lon, !!target_lat))</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@arrange</span>(distance_km)</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>nearest4 <span class="op">=</span> <span class="fu">first</span>(nearest_stations, <span class="fl">4</span>)</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>nearest_with_distance <span class="op">=</span> <span class="pp">@chain</span> nearest4 <span class="cf">begin</span></span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">#@select(noaa_id, name, distance_km, years_of_data)</span></span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="52" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb21"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"Nearest stations to </span><span class="sc">$</span>(my_station.noaa_id)<span class="st"> (stnid=782):"</span>)</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(nearest_with_distance)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>Nearest stations to 79-0061 (stnid=782):</code></pre>
</div>
<div class="cell-output cell-output-display">
<div><div style="float: left;"><span>4√ó8 DataFrame</span></div><div style="clear: both;"></div></div><div class="data-frame" style="overflow-x: scroll;">
<table class="data-frame caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;">Row</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">stnid</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">noaa_id</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">state</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">latitude</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">longitude</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">years_of_data</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">distance_km</th>
</tr>
<tr class="subheader headerLastRow even">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Unitful.Quantity{Float64, ùêã, Unitful.FreeUnits{(km,), ùêã, nothing}}">Quantity‚Ä¶</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1</td>
<td style="text-align: right;">387</td>
<td style="text-align: left;">41-4362</td>
<td style="text-align: left;">HUMBLE</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">30.0</td>
<td style="text-align: right;">-95.25</td>
<td style="text-align: right;">60</td>
<td style="text-align: right;">10.8366 km</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">2</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">60-0082</td>
<td style="text-align: left;">CYPRESS CK AT KUYKENDAHL RD</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">30.0244</td>
<td style="text-align: right;">-95.4764</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">12.2614 km</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">3</td>
<td style="text-align: right;">378</td>
<td style="text-align: left;">41-4323</td>
<td style="text-align: left;">HOUSTON INDEP HTS</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">29.8667</td>
<td style="text-align: right;">-95.4167</td>
<td style="text-align: right;">73</td>
<td style="text-align: right;">13.7474 km</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">4</td>
<td style="text-align: right;">6</td>
<td style="text-align: left;">60-0104</td>
<td style="text-align: left;">GREENS BYU AT MT HOUSTON PKWY</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">29.892</td>
<td style="text-align: right;">-95.238</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">15.3122 km</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Then I try to plot the annual precipitaion data together to check if all five stations have the same precipation data trend.</p>
</section>
<section id="plot-the-annual-data" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="plot-the-annual-data"><span class="header-section-number">2.2</span> Plot The Annual Data</h2>
<div id="54" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb23"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>my_station <span class="op">=</span> closest_station</span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>my_stnid <span class="op">=</span> my_station.stnid   <span class="co"># Stadion ID</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>station_data_list <span class="op">=</span> [</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>    (my_station, <span class="pp">@chain</span> rainfall_data begin</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@filter</span>(stnid <span class="op">==</span> !!my_stnid)   </span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@arrange</span>(date)</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">end</span>)</span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> row <span class="kw">in</span> <span class="fu">eachrow</span>(nearest4)</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>    row_id <span class="op">=</span> row.stnid  </span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>    df <span class="op">=</span> <span class="pp">@chain</span> rainfall_data <span class="cf">begin</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@filter</span>(stnid <span class="op">==</span> !!row_id)</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@arrange</span>(date)</span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">push!</span>(station_data_list, (row, df))</span>
<span id="cb23-18"><a href="#cb23-18" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb23-19"><a href="#cb23-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-20"><a href="#cb23-20" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot</span></span>
<span id="cb23-21"><a href="#cb23-21" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plot_multiple_stations</span>(station_data_list)</span>
<span id="cb23-22"><a href="#cb23-22" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size<span class="op">=</span>(<span class="fl">900</span>, <span class="fl">450</span>))</span>
<span id="cb23-23"><a href="#cb23-23" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>], xlabel<span class="op">=</span><span class="st">"Year"</span>, ylabel<span class="op">=</span><span class="st">"Annual Max Rainfall (inches)"</span>,</span>
<span id="cb23-24"><a href="#cb23-24" aria-hidden="true" tabindex="-1"></a>        title<span class="op">=</span><span class="st">"Annual Maximum Rainfall for HOUSTON INTERCONT AP and 4 Surrounding Stations"</span>)</span>
<span id="cb23-25"><a href="#cb23-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-26"><a href="#cb23-26" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> <span class="fu">distinguishable_colors</span>(<span class="fu">length</span>(station_data_list))</span>
<span id="cb23-27"><a href="#cb23-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-28"><a href="#cb23-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i, (station, data)) <span class="kw">in</span> <span class="fu">enumerate</span>(station_data_list)</span>
<span id="cb23-29"><a href="#cb23-29" aria-hidden="true" tabindex="-1"></a>        years <span class="op">=</span> data.year</span>
<span id="cb23-30"><a href="#cb23-30" aria-hidden="true" tabindex="-1"></a>        rain <span class="op">=</span> <span class="fu">ustrip</span>.(u<span class="st">"inch"</span>, data.rainfall)</span>
<span id="cb23-31"><a href="#cb23-31" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lines!</span>(ax, years, rain, color<span class="op">=</span>colors[i], label<span class="op">=</span>station.name)</span>
<span id="cb23-32"><a href="#cb23-32" aria-hidden="true" tabindex="-1"></a>        <span class="fu">scatter!</span>(ax, years, rain, color<span class="op">=</span>colors[i], markersize<span class="op">=</span><span class="fl">6</span>)</span>
<span id="cb23-33"><a href="#cb23-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb23-34"><a href="#cb23-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-35"><a href="#cb23-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axislegend</span>(ax; position<span class="op">=:</span>lt)</span>
<span id="cb23-36"><a href="#cb23-36" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> fig</span>
<span id="cb23-37"><a href="#cb23-37" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="56" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb24"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_multiple_stations</span>(station_data_list)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="assignment-1_files/figure-html/cell-29-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="fitting-gev-to-multiple-stations" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="fitting-gev-to-multiple-stations"><span class="header-section-number">2.3</span> Fitting GEV to Multiple Stations</h2>
<p>Now with the station datat from my station and the nearest 4, I could fit the GEV predition with <code>Extreme.jl</code> to them.</p>
<div id="58" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb25"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Selected station and the surround 4</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>station_rows <span class="op">=</span> <span class="fu">vcat</span>([my_station], <span class="fu">collect</span>(<span class="fu">eachrow</span>(nearest4)))</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a><span class="co"># GEV fitting</span></span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">fit_station_gev</span>(row)</span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a>    target_stnid <span class="op">=</span> row.stnid</span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>    st_precip <span class="op">=</span> <span class="pp">@chain</span> rainfall_data <span class="cf">begin</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@filter</span>(stnid <span class="op">==</span> !!target_stnid)   </span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@arrange</span>(date)</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>    y <span class="op">=</span> <span class="fu">collect</span>(<span class="fu">skipmissing</span>(<span class="fu">ustrip</span>.(u<span class="st">"inch"</span>, st_precip.rainfall)))</span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="fu">isempty</span>(y)</span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">error</span>(<span class="st">"Station </span><span class="sc">$</span>(row.noaa_id)<span class="st"> has no valid annual-maximum rainfall data."</span>)</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>    fit <span class="op">=</span> <span class="fu">gevfit</span>(y)</span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>    Œº <span class="op">=</span> <span class="fu">location</span>(fit)[<span class="fl">1</span>]</span>
<span id="cb25-18"><a href="#cb25-18" aria-hidden="true" tabindex="-1"></a>    œÉ <span class="op">=</span> <span class="fu">scale</span>(fit)[<span class="fl">1</span>]</span>
<span id="cb25-19"><a href="#cb25-19" aria-hidden="true" tabindex="-1"></a>    Œæ <span class="op">=</span> <span class="fu">shape</span>(fit)[<span class="fl">1</span>]</span>
<span id="cb25-20"><a href="#cb25-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-21"><a href="#cb25-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> (</span>
<span id="cb25-22"><a href="#cb25-22" aria-hidden="true" tabindex="-1"></a>        distribution <span class="op">=</span> <span class="fu">GeneralizedExtremeValue</span>(Œº, œÉ, Œæ),</span>
<span id="cb25-23"><a href="#cb25-23" aria-hidden="true" tabindex="-1"></a>        params <span class="op">=</span> (Œº <span class="op">=</span> Œº, œÉ <span class="op">=</span> œÉ, Œæ <span class="op">=</span> Œæ),</span>
<span id="cb25-24"><a href="#cb25-24" aria-hidden="true" tabindex="-1"></a>        info <span class="op">=</span> (stnid <span class="op">=</span> row.stnid, noaa_id <span class="op">=</span> row.noaa_id, name <span class="op">=</span> row.name, n_years <span class="op">=</span> <span class="fu">length</span>(y))</span>
<span id="cb25-25"><a href="#cb25-25" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb25-26"><a href="#cb25-26" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb25-27"><a href="#cb25-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-28"><a href="#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit for each 5 stations</span></span>
<span id="cb25-29"><a href="#cb25-29" aria-hidden="true" tabindex="-1"></a>fit_results <span class="op">=</span> <span class="fu">map</span>(fit_station_gev, station_rows)</span>
<span id="cb25-30"><a href="#cb25-30" aria-hidden="true" tabindex="-1"></a>station_fits  <span class="op">=</span> [r.distribution for r <span class="kw">in</span> fit_results]</span>
<span id="cb25-31"><a href="#cb25-31" aria-hidden="true" tabindex="-1"></a>station_infos <span class="op">=</span> [r.info for r <span class="kw">in</span> fit_results]</span>
<span id="cb25-32"><a href="#cb25-32" aria-hidden="true" tabindex="-1"></a>station_params <span class="op">=</span> [r.params for r <span class="kw">in</span> fit_results]</span>
<span id="cb25-33"><a href="#cb25-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-34"><a href="#cb25-34" aria-hidden="true" tabindex="-1"></a>params_df <span class="op">=</span> <span class="fu">DataFrame</span>(</span>
<span id="cb25-35"><a href="#cb25-35" aria-hidden="true" tabindex="-1"></a>    NOAA_ID <span class="op">=</span> [info.noaa_id for info <span class="kw">in</span> station_infos],</span>
<span id="cb25-36"><a href="#cb25-36" aria-hidden="true" tabindex="-1"></a>    Name    <span class="op">=</span> [info.name    for info <span class="kw">in</span> station_infos],</span>
<span id="cb25-37"><a href="#cb25-37" aria-hidden="true" tabindex="-1"></a>    Years   <span class="op">=</span> [info.n_years for info <span class="kw">in</span> station_infos],</span>
<span id="cb25-38"><a href="#cb25-38" aria-hidden="true" tabindex="-1"></a>    Œº       <span class="op">=</span> <span class="fu">round</span>.([p.Œº for p <span class="kw">in</span> station_params], digits<span class="op">=</span><span class="fl">3</span>),</span>
<span id="cb25-39"><a href="#cb25-39" aria-hidden="true" tabindex="-1"></a>    œÉ       <span class="op">=</span> <span class="fu">round</span>.([p.œÉ for p <span class="kw">in</span> station_params], digits<span class="op">=</span><span class="fl">3</span>),</span>
<span id="cb25-40"><a href="#cb25-40" aria-hidden="true" tabindex="-1"></a>    Œæ       <span class="op">=</span> <span class="fu">round</span>.([p.Œæ for p <span class="kw">in</span> station_params], digits<span class="op">=</span><span class="fl">3</span>),</span>
<span id="cb25-41"><a href="#cb25-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb25-42"><a href="#cb25-42" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"GEV parameters (MLE) for primary + 4 nearest stations:"</span>)</span>
<span id="cb25-43"><a href="#cb25-43" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(params_df)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-stdout">
<pre><code>GEV parameters (MLE) for primary + 4 nearest stations:</code></pre>
</div>
<div class="cell-output cell-output-display">
<div><div style="float: left;"><span>5√ó6 DataFrame</span></div><div style="clear: both;"></div></div><div class="data-frame" style="overflow-x: scroll;">
<table class="data-frame caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;">Row</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">NOAA_ID</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Years</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Œº</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">œÉ</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">Œæ</th>
</tr>
<tr class="subheader headerLastRow even">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1</td>
<td style="text-align: left;">79-0061</td>
<td style="text-align: left;">HOUSTON INTERCONT AP</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">3.752</td>
<td style="text-align: right;">1.457</td>
<td style="text-align: right;">0.251</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">2</td>
<td style="text-align: left;">41-4362</td>
<td style="text-align: left;">HUMBLE</td>
<td style="text-align: right;">60</td>
<td style="text-align: right;">3.601</td>
<td style="text-align: right;">1.655</td>
<td style="text-align: right;">0.13</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">3</td>
<td style="text-align: left;">60-0082</td>
<td style="text-align: left;">CYPRESS CK AT KUYKENDAHL RD</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">3.469</td>
<td style="text-align: right;">1.752</td>
<td style="text-align: right;">0.351</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">4</td>
<td style="text-align: left;">41-4323</td>
<td style="text-align: left;">HOUSTON INDEP HTS</td>
<td style="text-align: right;">73</td>
<td style="text-align: right;">3.44</td>
<td style="text-align: right;">1.311</td>
<td style="text-align: right;">0.273</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">5</td>
<td style="text-align: left;">60-0104</td>
<td style="text-align: left;">GREENS BYU AT MT HOUSTON PKWY</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">3.89</td>
<td style="text-align: right;">1.669</td>
<td style="text-align: right;">0.431</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The plot and tables following shows the GEV fitting results about different stations.</p>
<div id="60" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb27"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Set the return period</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>return_periods <span class="op">=</span> [<span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">25</span>, <span class="fl">50</span>, <span class="fl">100</span>]</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">return_level</span>(dist<span class="op">::</span><span class="dt">GeneralizedExtremeValue</span>, T)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    p <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="fl">1</span><span class="op">/</span>T <span class="co"># returen period model</span></span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fu">quantile</span>(dist, p)</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>rl_rows <span class="op">=</span> <span class="fu">Vector</span><span class="dt">{NamedTuple}</span>()</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (dist, info) <span class="kw">in</span> <span class="fu">zip</span>(station_fits, station_infos)</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> T <span class="kw">in</span> return_periods</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">push!</span>(rl_rows, (NOAA_ID<span class="op">=</span>info.noaa_id, Name<span class="op">=</span>info.name, Years<span class="op">=</span>info.n_years,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>                        T<span class="op">=</span>T, RL<span class="op">=</span><span class="fu">return_level</span>(dist, T)))</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>rl_long <span class="op">=</span> <span class="fu">DataFrame</span>(rl_rows)</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>rl_long.RL <span class="op">=</span> <span class="fu">round</span>.(rl_long.RL, digits<span class="op">=</span><span class="fl">2</span>)</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"Return levels (inches) at common return periods:"</span>)</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(rl_long)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>rl_wide <span class="op">=</span> <span class="fu">unstack</span>(rl_long, <span class="op">:</span>Name, <span class="op">:</span>T, <span class="op">:</span>RL)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a><span class="fu">println</span>(<span class="st">"Return levels (inches) wide table:"</span>)</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="fu">display</span>(rl_wide)</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Plot for comparesion</span></span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">create_return_period_range</span>(Tmin<span class="op">::</span><span class="dt">Real</span>, Tmax<span class="op">::</span><span class="dt">Real</span>, n<span class="op">::</span><span class="dt">Int</span>=<span class="fl">200</span>)</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="fl">10</span> <span class="op">.^</span> <span class="fu">range</span>(<span class="fu">log10</span>(Tmin), <span class="fu">log10</span>(Tmax), length<span class="op">=</span>n)</span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">plot_multi_station_comparison</span>(station_fits, station_infos)</span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size<span class="op">=</span>(<span class="fl">900</span>, <span class="fl">600</span>))</span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>],</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>        xlabel <span class="op">=</span> <span class="st">"Return Period (years)"</span>,</span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>        ylabel <span class="op">=</span> <span class="st">"Return Level (inches)"</span>,</span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>        title  <span class="op">=</span> <span class="st">"Multi-Station GEV Comparison (MLE)"</span>,</span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>        xscale <span class="op">=</span> log10)</span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> <span class="fu">distinguishable_colors</span>(<span class="fu">length</span>(station_fits))</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>    T_smooth <span class="op">=</span> <span class="fu">create_return_period_range</span>(<span class="fl">1.1</span>, <span class="fl">250</span>, <span class="fl">300</span>)</span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i, (dist, info)) <span class="kw">in</span> <span class="fu">enumerate</span>(<span class="fu">zip</span>(station_fits, station_infos))</span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>        levels <span class="op">=</span> [<span class="fu">quantile</span>(dist, <span class="fl">1</span> <span class="op">-</span> <span class="fl">1</span><span class="op">/</span>T) for T <span class="kw">in</span> T_smooth]</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>        <span class="fu">lines!</span>(ax, T_smooth, levels,</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>            color <span class="op">=</span> colors[i], linewidth <span class="op">=</span> <span class="fl">2</span>,</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>            label <span class="op">=</span> <span class="st">"</span><span class="sc">$</span>(info.noaa_id)<span class="st"> (</span><span class="sc">$</span>(info.n_years)<span class="st"> yrs)"</span>)</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>    ax.xticks <span class="op">=</span> (return_periods, <span class="fu">string</span>.(return_periods))</span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axislegend</span>(ax, position <span class="op">=</span> <span class="op">:</span>rb)</span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>    fig</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="62" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb28"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="fu">plot_multi_station_comparison</span>(station_fits, station_infos)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="assignment-1_files/figure-html/cell-32-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Task 2 finished.</p>
</section>
</section>
<section id="task-3-nonstationarity-analysis" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Task 3: Nonstationarity Analysis</h1>
<section id="load-co2-data" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="load-co2-data"><span class="header-section-number">3.1</span> Load CO2 Data</h2>
<p>Now let me run the nonstationarity analysis to check the reliability about my extrem value analysis.</p>
<p>First, I loaded the global mean CO2 concentration data, which comes from Mauna Loa (1959-2024) and from ice core reconstructions (pre-1959).</p>
<div id="64" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb29"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>co2_data <span class="op">=</span> <span class="kw">let</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    co2_fname <span class="op">=</span> <span class="fu">joinpath</span>(lab_dir, <span class="st">"logCo2.csv"</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    TidierFiles.<span class="fu">read_csv</span>(co2_fname) <span class="op">|&gt;</span> DataFrame</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>My primary satation is <code>Houston Internation Airport</code>. I loaded the data and run the potential trend signal of the CO2 data and combine them together.</p>
<div id="66" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb30"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>my_stnid <span class="op">=</span> <span class="fl">782</span>  <span class="co"># HOUSTON INTERCONT AP</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>my_station <span class="op">=</span> <span class="pp">@chain</span> stations <span class="cf">begin</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@filter</span>(stnid <span class="op">==</span> !!my_stnid)</span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>    first</span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>my_rainfall <span class="op">=</span> <span class="pp">@chain</span> rainfall_data <span class="cf">begin</span></span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@filter</span>(stnid <span class="op">==</span> !!my_stnid)</span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@arrange</span>(date)</span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@full_join</span>(co2_data, <span class="st">"year"</span>)  <span class="co"># Join with CO2 data</span></span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@arrange</span>(year)</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>my_rainfall_nomissing <span class="op">=</span> <span class="pp">@chain</span> my_rainfall <span class="cf">begin</span></span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@filter</span>(!<span class="fu">ismissing</span>(rainfall) <span class="op">&amp;&amp;</span> !<span class="fu">ismissing</span>(log_CO2))</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>station_time_series <span class="op">=</span> <span class="kw">let</span></span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size <span class="op">=</span> (<span class="fl">1200</span>, <span class="fl">600</span>))</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Top plot: Rainfall vs Year</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>], xlabel <span class="op">=</span> <span class="st">"Year"</span>, ylabel <span class="op">=</span> <span class="st">"Annual Max Rainfall (inches)"</span>,</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="st">"Annual Maximum Rainfall at </span><span class="sc">$</span>(my_station.name)<span class="st">, TX"</span>)</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>    years <span class="op">=</span> my_rainfall.year</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a>    rain <span class="op">=</span> <span class="fu">ustrip</span>.(u<span class="st">"inch"</span>, my_rainfall.rainfall)</span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines!</span>(ax1, years, rain, color <span class="op">=</span> <span class="op">:</span>blue)</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scatter!</span>(ax1, years, rain, color <span class="op">=</span> <span class="op">:</span>blue, markersize <span class="op">=</span> <span class="fl">8</span>)</span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Middle plot: CO2 vs Year</span></span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">2</span>, <span class="fl">1</span>], xlabel <span class="op">=</span> <span class="st">"Year"</span>, ylabel <span class="op">=</span> <span class="st">"CO‚ÇÇ Concentration (ppm)"</span>,</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="st">"Global Mean CO‚ÇÇ Concentration"</span>)</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">lines!</span>(ax2, years, my_rainfall.log_CO2, color <span class="op">=</span> <span class="op">:</span>red, linewidth <span class="op">=</span> <span class="fl">2</span>)</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bottom plot: Rainfall vs log(CO2)</span></span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>    ax3 <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, <span class="fl">2</span>], xlabel <span class="op">=</span> <span class="st">"log(CO‚ÇÇ) Concentration"</span>, ylabel <span class="op">=</span> <span class="st">"Annual Max Rainfall (inches)"</span>,</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="st">"Rainfall vs log(CO‚ÇÇ)"</span>)</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scatter!</span>(ax3, my_rainfall_nomissing.log_CO2, <span class="fu">ustrip</span>.(u<span class="st">"inch"</span>, my_rainfall_nomissing.rainfall), color <span class="op">=</span> <span class="op">:</span>green, markersize <span class="op">=</span> <span class="fl">8</span>, alpha <span class="op">=</span> <span class="fl">0.7</span>)</span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>    fig</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="assignment-1_files/figure-html/cell-34-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="mann-kendall-trend-test" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="mann-kendall-trend-test"><span class="header-section-number">3.2</span> Mann-Kendall Trend Test</h2>
<p>In order to understand the difference of the trend between the local station and the nearby station due to the inconsistent results, the nearby trends are needed to be analysised.</p>
<p>First, let me find the nearby data again. I will load 100 nearby data this time.</p>
<div id="68" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb31"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>nearby_stations <span class="op">=</span> <span class="fu">find_nearest_stations</span>(my_station, stations, <span class="fl">100</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>nearby_stations</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div><div style="float: left;"><span>100√ó8 DataFrame</span></div><div style="float: right;"><span style="font-style: italic;">95 rows omitted</span></div><div style="clear: both;"></div></div><div class="data-frame" style="overflow-x: scroll;">
<table class="data-frame caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;">Row</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">stnid</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">noaa_id</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">state</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">latitude</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">longitude</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">years_of_data</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">distance_km</th>
</tr>
<tr class="subheader headerLastRow even">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Unitful.Quantity{Float64, ùêã, Unitful.FreeUnits{(km,), ùêã, nothing}}">Quantity‚Ä¶</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1</td>
<td style="text-align: right;">782</td>
<td style="text-align: left;">79-0061</td>
<td style="text-align: left;">HOUSTON INTERCONT AP</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">29.98</td>
<td style="text-align: right;">-95.36</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">2.44121 km</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">2</td>
<td style="text-align: right;">387</td>
<td style="text-align: left;">41-4362</td>
<td style="text-align: left;">HUMBLE</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">30.0</td>
<td style="text-align: right;">-95.25</td>
<td style="text-align: right;">60</td>
<td style="text-align: right;">8.80564 km</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">3</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">60-0082</td>
<td style="text-align: left;">CYPRESS CK AT KUYKENDAHL RD</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">30.0244</td>
<td style="text-align: right;">-95.4764</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">14.6923 km</td>
</tr>
<tr class="even">
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
<td style="text-align: right;">‚ãÆ</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">99</td>
<td style="text-align: right;">537</td>
<td style="text-align: left;">41-6680</td>
<td style="text-align: left;">ORANGE 9 N</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">30.2264</td>
<td style="text-align: right;">-93.7394</td>
<td style="text-align: right;">63</td>
<td style="text-align: right;">156.316 km</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">100</td>
<td style="text-align: right;">310</td>
<td style="text-align: left;">41-3321</td>
<td style="text-align: left;">FRANKLIN</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">31.0328</td>
<td style="text-align: right;">-96.4889</td>
<td style="text-align: right;">44</td>
<td style="text-align: right;">161.679 km</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>Then, I applied the Mann-Kendall test to my nearby data. I made the assumption that no serial correlation is made. The exam table included the standardized test statistic with continuity correction (S) and the two-tailed p-value (P). I used the sum of signs of all pairwise differences for the test statistic. For the hypothesis, I considered that under Null hypothesis of no trend, for <code>n&gt;10</code>, S is normally distributed with mean 0 and variance <code>V = (n/18) * (n-1) * (2n+5)</code>.</p>
<div id="70" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb32"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">mann_kendall_test</span>(x<span class="op">::</span><span class="dt">AbstractVector</span>)</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">"""Mann-Kendall test for monotonic trend detection."""</span></span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>    n <span class="op">=</span> <span class="fu">length</span>(x)</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Test statistic: sum of signs of all pairwise differences</span></span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>    S <span class="op">=</span> <span class="fu">sum</span>(<span class="fu">sign</span>(x[j] <span class="op">-</span> x[i]) <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>(n<span class="op">-</span><span class="fl">1</span>) <span class="cf">for</span> j <span class="kw">in</span> (i<span class="op">+</span><span class="fl">1</span>)<span class="op">:</span>n)</span>
<span id="cb32-7"><a href="#cb32-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-8"><a href="#cb32-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># For n&gt;10, under Null Hypothesis of no trend,</span></span>
<span id="cb32-9"><a href="#cb32-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># S is Normally distributed with mean 0 and</span></span>
<span id="cb32-10"><a href="#cb32-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># variance V = (n/18) * (n-1) * (2n+5)</span></span>
<span id="cb32-11"><a href="#cb32-11" aria-hidden="true" tabindex="-1"></a>    var_S <span class="op">=</span> n <span class="op">*</span> (n <span class="op">-</span> <span class="fl">1</span>) <span class="op">*</span> (<span class="fl">2</span>n <span class="op">+</span> <span class="fl">5</span>) <span class="op">/</span> <span class="fl">18</span></span>
<span id="cb32-12"><a href="#cb32-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-13"><a href="#cb32-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Standardized test statistic with continuity correction</span></span>
<span id="cb32-14"><a href="#cb32-14" aria-hidden="true" tabindex="-1"></a>    Z <span class="op">=</span> <span class="cf">if</span> S <span class="op">&gt;</span> <span class="fl">0</span></span>
<span id="cb32-15"><a href="#cb32-15" aria-hidden="true" tabindex="-1"></a>        (S <span class="op">-</span> <span class="fl">1</span>) <span class="op">/</span> <span class="fu">sqrt</span>(var_S)</span>
<span id="cb32-16"><a href="#cb32-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">elseif</span> S <span class="op">&lt;</span> <span class="fl">0</span></span>
<span id="cb32-17"><a href="#cb32-17" aria-hidden="true" tabindex="-1"></a>        (S <span class="op">+</span> <span class="fl">1</span>) <span class="op">/</span> <span class="fu">sqrt</span>(var_S)</span>
<span id="cb32-18"><a href="#cb32-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span></span>
<span id="cb32-19"><a href="#cb32-19" aria-hidden="true" tabindex="-1"></a>        <span class="fl">0.0</span></span>
<span id="cb32-20"><a href="#cb32-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb32-21"><a href="#cb32-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-22"><a href="#cb32-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Two-tailed p-value</span></span>
<span id="cb32-23"><a href="#cb32-23" aria-hidden="true" tabindex="-1"></a>    p_value <span class="op">=</span> <span class="fl">2</span> <span class="op">*</span> (<span class="fl">1</span> <span class="op">-</span> <span class="fu">cdf</span>(<span class="fu">Normal</span>(<span class="fl">0</span>, <span class="fl">1</span>), <span class="fu">abs</span>(Z)))</span>
<span id="cb32-24"><a href="#cb32-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-25"><a href="#cb32-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> S, p_value</span>
<span id="cb32-26"><a href="#cb32-26" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now apply to my actual data - testing for trends in rainfall with respect to log(CO2):</p>
<div id="72" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb33"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a>prcp_obs <span class="op">=</span> <span class="fu">ustrip</span>.(u<span class="st">"inch"</span>, my_rainfall_nomissing.rainfall)</span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>mk_S, mk_p <span class="op">=</span> <span class="fu">mann_kendall_test</span>(prcp_obs)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>(114.0, 0.31521063479231004)</code></pre>
</div>
</div>
<p>The <code>S value</code> equals to 114 and the <code>p-value</code> equals to 0.315. The S value indicates that compare with the sum of signs of all pairwise differences the data show a strong positive differences. The big <code>S value</code> reflects the strong vibration to the data, which may increase the uncertanty. The <code>p-value</code> is bigger than 0.05, indicates a rejection to the null hypothesis.</p>
<p>Now I applied these tests to all nearby stations and reported the results for the nearby 4 stations.</p>
<div id="74" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb35"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    stnids <span class="op">=</span> nearby_stations.stnid</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    raw_results <span class="op">=</span> <span class="fu">map</span>(stnids) <span class="cf">do</span> stnid</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>        df <span class="op">=</span> <span class="pp">@chain</span> rainfall_data <span class="cf">begin</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>            <span class="pp">@filter</span>(stnid <span class="op">==</span> !!stnid)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>            <span class="pp">@filter</span>(!<span class="fu">ismissing</span>(rainfall))</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        prcp <span class="op">=</span> <span class="fu">ustrip</span>.(u<span class="st">"inch"</span>, df.rainfall)</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>        mk_S, mk_p <span class="op">=</span> <span class="fu">mann_kendall_test</span>(prcp)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> mk_S, mk_p</span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>    nearby_stations[!, <span class="op">:</span>mk_S] <span class="op">=</span> <span class="fu">getindex</span>.(raw_results, <span class="fl">1</span>)</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>    nearby_stations[!, <span class="op">:</span>mk_pvalue] <span class="op">=</span> <span class="fu">getindex</span>.(raw_results, <span class="fl">2</span>)</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>nearby_stations <span class="op">=</span> <span class="pp">@chain</span> nearby_stations <span class="cf">begin</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@select</span>(stnid, noaa_id, name, state, latitude, longitude, years_of_data, mk_S, mk_pvalue)</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a><span class="fu">first</span>(nearby_stations, <span class="fl">5</span>)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div><div style="float: left;"><span>5√ó9 DataFrame</span></div><div style="clear: both;"></div></div><div class="data-frame" style="overflow-x: scroll;">
<table class="data-frame caption-top table table-sm table-striped small">
<thead>
<tr class="header">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;">Row</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">stnid</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">noaa_id</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">name</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">state</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">latitude</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">longitude</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">years_of_data</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">mk_S</th>
<th style="text-align: left;" data-quarto-table-cell-role="th">mk_pvalue</th>
</tr>
<tr class="subheader headerLastRow even">
<th class="rowNumber" data-quarto-table-cell-role="th" style="text-align: right; font-weight: bold;"></th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="String">String</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Int64">Int64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
<th style="text-align: left;" data-quarto-table-cell-role="th" title="Float64">Float64</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">1</td>
<td style="text-align: right;">782</td>
<td style="text-align: left;">79-0061</td>
<td style="text-align: left;">HOUSTON INTERCONT AP</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">29.98</td>
<td style="text-align: right;">-95.36</td>
<td style="text-align: right;">48</td>
<td style="text-align: right;">114.0</td>
<td style="text-align: right;">0.315211</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">2</td>
<td style="text-align: right;">387</td>
<td style="text-align: left;">41-4362</td>
<td style="text-align: left;">HUMBLE</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">30.0</td>
<td style="text-align: right;">-95.25</td>
<td style="text-align: right;">60</td>
<td style="text-align: right;">239.0</td>
<td style="text-align: right;">0.129028</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">3</td>
<td style="text-align: right;">5</td>
<td style="text-align: left;">60-0082</td>
<td style="text-align: left;">CYPRESS CK AT KUYKENDAHL RD</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">30.0244</td>
<td style="text-align: right;">-95.4764</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">134.0</td>
<td style="text-align: right;">0.0237888</td>
</tr>
<tr class="even">
<td class="rowNumber" style="text-align: right; font-weight: bold;">4</td>
<td style="text-align: right;">378</td>
<td style="text-align: left;">41-4323</td>
<td style="text-align: left;">HOUSTON INDEP HTS</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">29.8667</td>
<td style="text-align: right;">-95.4167</td>
<td style="text-align: right;">73</td>
<td style="text-align: right;">336.0</td>
<td style="text-align: right;">0.110627</td>
</tr>
<tr class="odd">
<td class="rowNumber" style="text-align: right; font-weight: bold;">5</td>
<td style="text-align: right;">6</td>
<td style="text-align: left;">60-0104</td>
<td style="text-align: left;">GREENS BYU AT MT HOUSTON PKWY</td>
<td style="text-align: left;">TX</td>
<td style="text-align: right;">29.892</td>
<td style="text-align: right;">-95.238</td>
<td style="text-align: right;">31</td>
<td style="text-align: right;">69.0</td>
<td style="text-align: right;">0.247781</td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<p>The spatial inconsistency in trend results highlights problems with single-station analysis: nearby stations show contradictory trends that are not climatologically plausible, suggesting that individual station records contain too much noise to reliably detect regional climate signals.</p>
</section>
<section id="two-nonstationary-gev-models" class="level2" data-number="3.3">
<h2 data-number="3.3" class="anchored" data-anchor-id="two-nonstationary-gev-models"><span class="header-section-number">3.3</span> Two Nonstationary GEV models</h2>
<p>Traditional extreme value analysis assumes parameters remain constant over time (stationarity). However, climate change may alter the distribution of extreme precipitation. <strong>Nonstationarity</strong> means the statistical properties of extremes change systematically with time or other covariates.</p>
<p>We‚Äôll use atmospheric CO‚ÇÇ concentration as our covariate <span class="math inline">\(x = \log(\text{CO}_2)\)</span> because: - CO‚ÇÇ is a primary driver of global warming - Higher temperatures can increase atmospheric moisture capacity - This may intensify extreme precipitation events</p>
<p>I implement two models that allow different GEV parameters to vary with CO‚ÇÇ (the same as lab):</p>
<ol type="1">
<li><strong>Location-varying model</strong>: Only the location parameter changes with CO‚ÇÇ</li>
<li><strong>Location and scale varying model</strong>: Both location and scale parameters change with CO‚ÇÇ</li>
</ol>
<div id="76" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb36"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">nonstationary_gev_model1</span>(y, x)</span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Model 1: Œº(x) = Œ±_Œº + Œ≤_Œº*x where x = log(CO2)</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    Œ±_Œº <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">3.0</span>, <span class="fl">2.0</span>)    <span class="co"># baseline location parameter</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a>    Œ≤_Œº <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0.0</span>, <span class="fl">2.0</span>)    <span class="co"># location trend parameter (inches per log(ppm))</span></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    log_œÉ <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0.0</span>, <span class="fl">1.0</span>)  <span class="co"># log-scale parameter</span></span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>    Œæ <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0.0</span>, <span class="fl">0.3</span>)      <span class="co"># shape parameter</span></span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>    œÉ <span class="op">=</span> <span class="fu">exp</span>(log_œÉ)</span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Location parameter varies with CO2</span></span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(y)</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>        x_centered <span class="op">=</span> x[i] <span class="op">-</span> <span class="fu">log</span>(<span class="fl">380</span>)  <span class="co"># center around ~380 ppm</span></span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>        Œº_x <span class="op">=</span> Œ±_Œº <span class="op">+</span> Œ≤_Œº <span class="op">*</span> x_centered</span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>        dist <span class="op">=</span> <span class="fu">GeneralizedExtremeValue</span>(Œº_x, œÉ, Œæ)</span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a>        y[i] <span class="op">~</span> dist</span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">nonstationary_gev_model2</span>(y, x)</span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Model 2: Œº(x) = Œ±_Œº + Œ≤_Œº*x, œÉ(x) = Œ±_œÉ + Œ≤_œÉ*x</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a>    Œ±_Œº <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">3.0</span>, <span class="fl">2.0</span>)      <span class="co"># baseline location parameter</span></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    Œ≤_Œº <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0.0</span>, <span class="fl">2.0</span>)      <span class="co"># location trend parameter</span></span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>    Œ±_œÉ <span class="op">~</span> <span class="fu">LogNormal</span>(<span class="fl">0.0</span>, <span class="fl">1.0</span>)   <span class="co"># baseline scale parameter</span></span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>    Œ≤_œÉ <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0.0</span>, <span class="fl">0.2</span>)      <span class="co"># scale trend parameter (small prior)</span></span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>    Œæ <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0.0</span>, <span class="fl">0.3</span>)        <span class="co"># shape parameter</span></span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fu">eachindex</span>(y)</span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>        x_centered <span class="op">=</span> x[i] <span class="op">-</span> <span class="fu">log</span>(<span class="fl">380</span>)</span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>        Œº_x <span class="op">=</span> Œ±_Œº <span class="op">+</span> Œ≤_Œº <span class="op">*</span> x_centered</span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>        œÉ_x <span class="op">=</span> Œ±_œÉ <span class="op">+</span> Œ≤_œÉ <span class="op">*</span> x_centered</span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Ensure positive scale parameter</span></span>
<span id="cb36-33"><a href="#cb36-33" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> œÉ_x <span class="op">&gt;</span> <span class="fl">0.1</span></span>
<span id="cb36-34"><a href="#cb36-34" aria-hidden="true" tabindex="-1"></a>            dist <span class="op">=</span> <span class="fu">GeneralizedExtremeValue</span>(Œº_x, œÉ_x, Œæ)</span>
<span id="cb36-35"><a href="#cb36-35" aria-hidden="true" tabindex="-1"></a>            y[i] <span class="op">~</span> dist</span>
<span id="cb36-36"><a href="#cb36-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span></span>
<span id="cb36-37"><a href="#cb36-37" aria-hidden="true" tabindex="-1"></a>            Turing.<span class="pp">@addlogprob</span>!(<span class="op">-</span><span class="cn">Inf</span>)</span>
<span id="cb36-38"><a href="#cb36-38" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb36-39"><a href="#cb36-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb36-40"><a href="#cb36-40" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Next I fit these two models to my primary station, Houston Internation Airport.</p>
<div id="78" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb37"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>y_obs <span class="op">=</span> <span class="fu">ustrip</span>.(u<span class="st">"inch"</span>, my_rainfall_nomissing.rainfall)</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>x_obs <span class="op">=</span> my_rainfall_nomissing.log_CO2  <span class="co"># x = log(CO2)</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit the two models</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>models <span class="op">=</span> [</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"Location trend"</span>, <span class="fu">nonstationary_gev_model1</span>(y_obs, x_obs)),</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    (<span class="st">"Location + Scale trends"</span>, <span class="fu">nonstationary_gev_model2</span>(y_obs, x_obs)),</span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Sample from posteriors and check diagnostics</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>posterior_results <span class="op">=</span> []</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> (name, model) <span class="kw">in</span> models</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    fname <span class="op">=</span> <span class="fu">joinpath</span>(lab_dir, <span class="st">"nonstat_</span><span class="sc">$</span>(<span class="fu">replace</span>(name, <span class="st">" "</span> <span class="op">=&gt;</span> <span class="st">"_"</span>))<span class="st">.nc"</span>)</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    overwrite <span class="op">=</span> <span class="cn">false</span></span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    idata <span class="op">=</span> <span class="fu">load_or_sample</span>(fname, model; overwrite <span class="op">=</span> overwrite, samples_per_chain <span class="op">=</span> <span class="fl">1000</span>)</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">push!</span>(posterior_results, (name <span class="op">=</span> name, idata <span class="op">=</span> idata))</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check diagnostics immediately after fitting</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"=== Diagnostics for </span><span class="sc">$</span>name<span class="st"> ==="</span>)</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">display</span>(ArviZ.<span class="fu">summarize</span>(idata))</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a><span class="cf">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Create traceplots to visualize MCMC chain behavior for key parameters:</p>
<div id="80" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb38"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Traceplots for Model 1</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>model1_traceplots <span class="op">=</span> <span class="kw">let</span></span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size <span class="op">=</span> (<span class="fl">1200</span>, <span class="fl">600</span>))</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>    param_names <span class="op">=</span> [<span class="op">:</span>Œ±_Œº, <span class="op">:</span>Œ≤_Œº, <span class="op">:</span>log_œÉ, <span class="op">:</span>Œæ]</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i, param) <span class="kw">in</span> <span class="fu">enumerate</span>(param_names)</span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> <span class="fu">Axis</span>(fig[i, <span class="fl">1</span>], xlabel <span class="op">=</span> i <span class="op">==</span> <span class="fu">length</span>(param_names) ? <span class="st">"Iteration"</span> <span class="op">:</span> <span class="st">""</span>,</span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>            ylabel <span class="op">=</span> <span class="fu">string</span>(param), title <span class="op">=</span> i <span class="op">==</span> <span class="fl">1</span> ? <span class="st">"Model 1 (Location Trend)"</span> <span class="op">:</span> <span class="st">""</span>)</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">traceplot!</span>(ax, posterior_results[<span class="fl">1</span>].idata, param)</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    fig</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="assignment-1_files/figure-html/cell-41-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<div id="82" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb39"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Traceplots for Model 2</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>model2_traceplots <span class="op">=</span> <span class="kw">let</span></span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size <span class="op">=</span> (<span class="fl">1200</span>, <span class="fl">800</span>))</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    param_names <span class="op">=</span> [<span class="op">:</span>Œ±_Œº, <span class="op">:</span>Œ≤_Œº, <span class="op">:</span>Œ±_œÉ, <span class="op">:</span>Œ≤_œÉ, <span class="op">:</span>Œæ]</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i, param) <span class="kw">in</span> <span class="fu">enumerate</span>(param_names)</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> <span class="fu">Axis</span>(fig[i, <span class="fl">1</span>], xlabel <span class="op">=</span> i <span class="op">==</span> <span class="fu">length</span>(param_names) ? <span class="st">"Iteration"</span> <span class="op">:</span> <span class="st">""</span>,</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>            ylabel <span class="op">=</span> <span class="fu">string</span>(param), title <span class="op">=</span> i <span class="op">==</span> <span class="fl">1</span> ? <span class="st">"Model 2 (Location + Scale Trends)"</span> <span class="op">:</span> <span class="st">""</span>)</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">traceplot!</span>(ax, posterior_results[<span class="fl">2</span>].idata, param)</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>    fig</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="assignment-1_files/figure-html/cell-42-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Check convergence: effective sample size should exceed 400, R-hat should be near 1.0, and traceplots should show good mixing across chains.</p>
</section>
<section id="extracting-gev-distributions" class="level2" data-number="3.4">
<h2 data-number="3.4" class="anchored" data-anchor-id="extracting-gev-distributions"><span class="header-section-number">3.4</span> Extracting GEV Distributions</h2>
<p>First, let‚Äôs define functions to extract GEV distributions for any year across our two nonstationary models:</p>
<div id="84" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb40"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 1: Location trend only</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">extract_model1_gevs</span>(idata, x)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>    x_centered <span class="op">=</span> x <span class="op">-</span> <span class="fu">log</span>(<span class="fl">380</span>)  <span class="co"># center around ~380 ppm</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>    Œ±_Œº <span class="op">=</span> <span class="fu">Array</span>(idata.posterior[<span class="op">:</span>Œ±_Œº])</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    Œ≤_Œº <span class="op">=</span> <span class="fu">Array</span>(idata.posterior[<span class="op">:</span>Œ≤_Œº])</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    œÉ <span class="op">=</span> <span class="fu">exp</span>.(<span class="fu">Array</span>(idata.posterior[<span class="op">:</span>log_œÉ]))</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>    Œæ <span class="op">=</span> <span class="fu">Array</span>(idata.posterior[<span class="op">:</span>Œæ])</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>    Œº_x <span class="op">=</span> Œ±_Œº <span class="op">.+</span> Œ≤_Œº <span class="op">.*</span> x_centered</span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vec</span>(<span class="fu">GeneralizedExtremeValue</span>.(Œº_x, œÉ, Œæ))</span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="co"># Model 2: Location + Scale trends</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a><span class="kw">function</span> <span class="fu">extract_model2_gevs</span>(idata, x)</span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    x_centered <span class="op">=</span> x <span class="op">-</span> <span class="fu">log</span>(<span class="fl">380</span>)</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    Œ±_Œº <span class="op">=</span> <span class="fu">Array</span>(idata.posterior[<span class="op">:</span>Œ±_Œº])</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>    Œ≤_Œº <span class="op">=</span> <span class="fu">Array</span>(idata.posterior[<span class="op">:</span>Œ≤_Œº])</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    Œ±_œÉ <span class="op">=</span> <span class="fu">Array</span>(idata.posterior[<span class="op">:</span>Œ±_œÉ])</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    Œ≤_œÉ <span class="op">=</span> <span class="fu">Array</span>(idata.posterior[<span class="op">:</span>Œ≤_œÉ])</span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    Œæ <span class="op">=</span> <span class="fu">Array</span>(idata.posterior[<span class="op">:</span>Œæ])</span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a>    Œº_x <span class="op">=</span> Œ±_Œº <span class="op">.+</span> Œ≤_Œº <span class="op">.*</span> x_centered</span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    œÉ_x <span class="op">=</span> Œ±_œÉ <span class="op">.+</span> Œ≤_œÉ <span class="op">.*</span> x_centered</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Filter out negative scale parameters</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>    valid <span class="op">=</span> œÉ_x <span class="op">.&gt;</span> <span class="fl">0.1</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">vec</span>(<span class="fu">GeneralizedExtremeValue</span>.(Œº_x[valid], œÉ_x[valid], Œæ[valid]))</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Now extract GEV distributions for both 1950 and 2025 using appropriate CO2 levels:</p>
<div id="86" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb41"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract data for each model</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>model1_name, model1_idata <span class="op">=</span> posterior_results[<span class="fl">1</span>].name, posterior_results[<span class="fl">1</span>].idata</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>model2_name, model2_idata <span class="op">=</span> posterior_results[<span class="fl">2</span>].name, posterior_results[<span class="fl">2</span>].idata</span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Approximate CO2 levels (x = log(CO2))</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>x_1950 <span class="op">=</span> co2_data.log_CO2[co2_data.year<span class="op">.==</span><span class="fl">1950</span>][<span class="fl">1</span>]  <span class="co"># ~310 ppm in 1950</span></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>x_2025 <span class="op">=</span> co2_data.log_CO2[co2_data.year<span class="op">.==</span><span class="fl">2024</span>][<span class="fl">1</span>]  <span class="co"># ~425 ppm projected for 2025</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract GEV distributions for both time periods</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>gevs_1950 <span class="op">=</span> [</span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">extract_model1_gevs</span>(model1_idata, x_1950),</span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">extract_model2_gevs</span>(model2_idata, x_1950),</span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>]</span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>gevs_2025 <span class="op">=</span> [</span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">extract_model1_gevs</span>(model1_idata, x_2025),</span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">extract_model2_gevs</span>(model2_idata, x_2025),</span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>]</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>For the Houston Airport (IAH) station and its nearby stations, I adopted the same nonstationary GEV framework introduced earlier in the lab. My choice of covariate was the atmospheric CO‚ÇÇ concentration, which acts as a long-term climate driver. CO‚ÇÇ captures the monotonic global warming signal, and its rise could be linked to increases in atmospheric moisture capacity and the potential intensification of extreme rainfall. Using log(CO‚ÇÇ) as a covariate is therefore both physically justified and statistically useful for stabilizing inference across noisy station records.</p>
<p>I specified two model structures. In the <code>Location-trend model</code>, only the GEV location parameter varies with CO‚ÇÇ, reflecting a systematic upward or downward shift in rainfall extremes while keeping scale and shape constant. In the <code>Location + Scale-trend model</code>, both the location and scale parameters respond to CO‚ÇÇ, allowing the distribution to shift and stretch over time. These two specifications let us test whether climate forcing primarily shifts the center of the extremes, or also alters their spread.</p>
</section>
<section id="model-comparison-and-uncertainty" class="level2" data-number="3.5">
<h2 data-number="3.5" class="anchored" data-anchor-id="model-comparison-and-uncertainty"><span class="header-section-number">3.5</span> Model Comparison and Uncertainty</h2>
<div id="88" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb42"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Create comprehensive comparison: 1950 vs 2025 across both models</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>fig_comprehensive <span class="op">=</span> <span class="kw">let</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size <span class="op">=</span> (<span class="fl">1000</span>, <span class="fl">700</span>))</span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>    rts <span class="op">=</span> <span class="fu">logrange</span>(<span class="fl">1.1</span>, <span class="fl">250</span>, <span class="fl">100</span>)</span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>    xticks <span class="op">=</span> [<span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">25</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">250</span>]</span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Top row: 1950 vs 2025 comparison for each model (adjust column widths)</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>], xlabel <span class="op">=</span> <span class="st">"Return Period (years)"</span>, ylabel <span class="op">=</span> <span class="st">"Return Level (inches)"</span>,</span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="st">"Location Trend Model"</span>, xscale <span class="op">=</span> log10, xticks <span class="op">=</span> xticks)</span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">2</span>], xlabel <span class="op">=</span> <span class="st">"Return Period (years)"</span>, ylabel <span class="op">=</span> <span class="st">"Return Level (inches)"</span>,</span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="st">"Location + Scale Trends Model"</span>, xscale <span class="op">=</span> log10, xticks <span class="op">=</span> xticks)</span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Make columns equal width</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colsize!</span>(fig.layout, <span class="fl">1</span>, <span class="fu">Relative</span>(<span class="fl">0.5</span>))</span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">colsize!</span>(fig.layout, <span class="fl">2</span>, <span class="fu">Relative</span>(<span class="fl">0.5</span>))</span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>    top_axes <span class="op">=</span> [ax1, ax2]</span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i, (ax, gevs_50, gevs_25)) <span class="kw">in</span> <span class="fu">enumerate</span>(<span class="fu">zip</span>(top_axes, gevs_1950, gevs_2025))</span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">posterior_bands!</span>(ax, gevs_50, rts; ci <span class="op">=</span> <span class="fl">0.90</span>, color <span class="op">=</span> (<span class="op">:</span>blue, <span class="fl">0.3</span>))</span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">posterior_mean_curve!</span>(ax, gevs_50, rts; color <span class="op">=</span> <span class="op">:</span>blue, linewidth <span class="op">=</span> <span class="fl">2</span>, label <span class="op">=</span> <span class="st">"1950"</span>)</span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">posterior_bands!</span>(ax, gevs_25, rts; ci <span class="op">=</span> <span class="fl">0.90</span>, color <span class="op">=</span> (<span class="op">:</span>red, <span class="fl">0.3</span>))</span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">posterior_mean_curve!</span>(ax, gevs_25, rts; color <span class="op">=</span> <span class="op">:</span>red, linewidth <span class="op">=</span> <span class="fl">2</span>, label <span class="op">=</span> <span class="st">"2025"</span>)</span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> i <span class="op">==</span> <span class="fl">1</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>            <span class="fu">axislegend</span>(ax, position <span class="op">=</span> <span class="op">:</span>rb)</span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Bottom: Direct model comparison for 2025</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>    ax3 <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">2</span>, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>], xlabel <span class="op">=</span> <span class="st">"Return Period (years)"</span>, ylabel <span class="op">=</span> <span class="st">"Return Level (inches)"</span>,</span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="st">"Model Comparison for 2025 (Note: Models Show Similar Behavior)"</span>,</span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>        xscale <span class="op">=</span> log10, xticks <span class="op">=</span> xticks)</span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>    colors <span class="op">=</span> [<span class="op">:</span>blue, <span class="op">:</span>red]</span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>    labels <span class="op">=</span> [<span class="st">"Location Trend"</span>, <span class="st">"Location + Scale"</span>]</span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i, (gevs, color, label)) <span class="kw">in</span> <span class="fu">enumerate</span>(<span class="fu">zip</span>(gevs_2025, colors, labels))</span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>        <span class="fu">posterior_bands!</span>(ax3, gevs, rts; ci <span class="op">=</span> <span class="fl">0.68</span>, color <span class="op">=</span> (color, <span class="fl">0.3</span>))</span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>        <span class="fu">posterior_mean_curve!</span>(ax3, gevs, rts; color <span class="op">=</span> color, linewidth <span class="op">=</span> <span class="fl">2</span>, label <span class="op">=</span> label)</span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axislegend</span>(ax3, position <span class="op">=</span> <span class="op">:</span>lt)</span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>    <span class="fu">linkyaxes!</span>(top_axes<span class="op">...</span>)</span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>    fig</span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="assignment-1_files/figure-html/cell-45-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The two models show remarkably similar behavior, which is actually quite interesting - it suggests that for this dataset, allowing the scale parameter to vary with CO‚ÇÇ doesn‚Äôt dramatically change the return level projections. Let‚Äôs examine the 100-year return period distributions more closely:</p>
<div id="90" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb43"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a>fig_rl100_comparison <span class="op">=</span> <span class="kw">let</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size <span class="op">=</span> (<span class="fl">800</span>, <span class="fl">400</span>))</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    titles <span class="op">=</span> [<span class="st">"Location Trend"</span>, <span class="st">"Location + Scale"</span>]</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fl">2</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, i], xlabel <span class="op">=</span> <span class="st">"100-year RL (inches)"</span>, ylabel <span class="op">=</span> <span class="st">"Count"</span>, title <span class="op">=</span> titles[i])</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Calculate 100-year return levels</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>        rl_1950 <span class="op">=</span> [<span class="fu">quantile</span>(gev, <span class="fl">0.99</span>) for gev <span class="kw">in</span> gevs_1950[i]]</span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>        rl_2025 <span class="op">=</span> [<span class="fu">quantile</span>(gev, <span class="fl">0.99</span>) for gev <span class="kw">in</span> gevs_2025[i]]</span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Plot histograms</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">hist!</span>(ax, rl_1950, bins <span class="op">=</span> <span class="fl">25</span>, color <span class="op">=</span> (<span class="op">:</span>purple, <span class="fl">0.5</span>), label <span class="op">=</span> <span class="st">"1950"</span>)</span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">hist!</span>(ax, rl_2025, bins <span class="op">=</span> <span class="fl">25</span>, color <span class="op">=</span> (<span class="op">:</span>orange, <span class="fl">0.5</span>), label <span class="op">=</span> <span class="st">"2025"</span>)</span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>        i <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;&amp;</span> <span class="fu">axislegend</span>(ax, position <span class="op">=</span> <span class="op">:</span>rt)</span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>    fig</span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="assignment-1_files/figure-html/cell-46-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The large posterior uncertainties in single-station models, particularly for return level projections, indicate that individual stations lack sufficient data to reliably estimate trends in extreme precipitation.</p>
<p>For IAH and nearby stations, using log(CO‚ÇÇ) as a covariate captures the climate‚Äêdriven intensification of extremes. Both the location‚Äêonly and location+scale models show consistent results: return level curves from 1950 to 2025 diverge, with higher CO‚ÇÇ linked to larger return levels. Histograms confirm that 100-year return levels shift upward, and trace plots show stable model convergence. Overall, both models indicate substantial increases in 50- to 100-year storms under future conditions, highlighting the need for nonstationary modeling in risk management and design.</p>
</section>
</section>
<section id="task-4-regional-parameter-estimation" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Task 4: Regional Parameter Estimation</h1>
<section id="regional-model-design" class="level2" data-number="4.1">
<h2 data-number="4.1" class="anchored" data-anchor-id="regional-model-design"><span class="header-section-number">4.1</span> Regional Model Design</h2>
<p>The large uncertainties in single-station analyses motivate regional approaches. My regional GEV model uses a simple approach where some parameters are shared regionally while others vary by station (similar to the lab).</p>
<p>For station <span class="math inline">\(i\)</span> in year <span class="math inline">\(t\)</span>:</p>
<p><span class="math display">\[Y_{i,t} \sim \text{GEV}(\mu_{i,t}, \sigma_i, \xi_{\text{region}})\]</span></p>
<p>where:</p>
<ul>
<li><strong>Regional parameters</strong>: <span class="math inline">\(\beta_{\text{region}}\)</span> (trend) and <span class="math inline">\(\xi_{\text{region}}\)</span> (shape) are the same for all stations</li>
<li><strong>Station-specific parameters</strong>: <span class="math inline">\(\alpha_{\mu,i}\)</span> (baseline location) and <span class="math inline">\(\sigma_i\)</span> (scale) differ by station</li>
</ul>
<p>The location parameter varies with the covariate <span class="math inline">\(x = \log(\text{CO}_2)\)</span>: <span class="math display">\[\mu_{i,t} = \alpha_{\mu,i} + \beta_{\text{region}} \cdot (x_t - \log(380))\]</span></p>
<p>This approach assumes climate change affects trend and extreme value tail behavior similarly across the region, while allowing for local differences in baseline precipitation amounts and variability.</p>
<p>We‚Äôll select the 8 closest stations with at least 40 years of data</p>
<div id="92" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb44"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>analysis_stations <span class="op">=</span> <span class="kw">let</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>    lon <span class="op">=</span> my_station.longitude</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>    lat <span class="op">=</span> my_station.latitude</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>    <span class="pp">@chain</span> nearby_stations <span class="cf">begin</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@filter</span>(years_of_data <span class="op">&gt;=</span> <span class="fl">40</span>)</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@mutate</span>(distance <span class="op">=</span> <span class="fu">calc_distance</span>(!!lat, !!lon, latitude, longitude))</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@arrange</span>(distance)</span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">first</span>(<span class="fl">8</span>)</span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>analysis_stnids <span class="op">=</span> analysis_stations.stnid</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>To analyze the data, I converted the data to a matrix, where each row corresponds to a year and each column corresponds to a station.</p>
<div id="94" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb45"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a>years_vec, rainfall_matrix <span class="op">=</span> <span class="kw">let</span></span>
<span id="cb45-2"><a href="#cb45-2" aria-hidden="true" tabindex="-1"></a>    rainfall_matrix_data <span class="op">=</span> <span class="pp">@chain</span> rainfall_data <span class="cf">begin</span></span>
<span id="cb45-3"><a href="#cb45-3" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@filter</span>(<span class="fu">in</span>(stnid, !!analysis_stnids))</span>
<span id="cb45-4"><a href="#cb45-4" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@mutate</span>(rainfall_inch <span class="op">=</span> <span class="fu">ifelse</span>(<span class="fu">ismissing</span>(rainfall), <span class="cn">missing</span>, <span class="fu">ustrip</span>(u<span class="st">"inch"</span>, rainfall)))</span>
<span id="cb45-5"><a href="#cb45-5" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@select</span>(year, stnid, rainfall_inch)</span>
<span id="cb45-6"><a href="#cb45-6" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@pivot_wider</span>(names_from <span class="op">=</span> stnid, values_from <span class="op">=</span> rainfall_inch)</span>
<span id="cb45-7"><a href="#cb45-7" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@arrange</span>(year)</span>
<span id="cb45-8"><a href="#cb45-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb45-9"><a href="#cb45-9" aria-hidden="true" tabindex="-1"></a>    years <span class="op">=</span> rainfall_matrix_data.year</span>
<span id="cb45-10"><a href="#cb45-10" aria-hidden="true" tabindex="-1"></a>    matrix <span class="op">=</span> <span class="fu">Matrix</span>(rainfall_matrix_data[<span class="op">:</span>, <span class="fl">2</span><span class="op">:</span><span class="kw">end</span>])</span>
<span id="cb45-11"><a href="#cb45-11" aria-hidden="true" tabindex="-1"></a>    years, matrix</span>
<span id="cb45-12"><a href="#cb45-12" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>Then I prepared the data matrices for the hierarchical analysis:</p>
<div id="96" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb46"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare matrices for regional model</span></span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>y_matrix, x_vector <span class="op">=</span> <span class="kw">let</span></span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get rainfall matrix: [year, station]</span></span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>    rainfall_wide <span class="op">=</span> <span class="pp">@chain</span> rainfall_data <span class="cf">begin</span></span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@filter</span>(<span class="fu">in</span>(stnid, !!analysis_stnids))</span>
<span id="cb46-6"><a href="#cb46-6" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@mutate</span>(rainfall_inch <span class="op">=</span> <span class="fu">ustrip</span>(u<span class="st">"inch"</span>, rainfall))</span>
<span id="cb46-7"><a href="#cb46-7" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@select</span>(year, stnid, rainfall_inch)</span>
<span id="cb46-8"><a href="#cb46-8" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@pivot_wider</span>(names_from <span class="op">=</span> stnid, values_from <span class="op">=</span> rainfall_inch)</span>
<span id="cb46-9"><a href="#cb46-9" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@arrange</span>(year)</span>
<span id="cb46-10"><a href="#cb46-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb46-11"><a href="#cb46-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-12"><a href="#cb46-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract years and matrix</span></span>
<span id="cb46-13"><a href="#cb46-13" aria-hidden="true" tabindex="-1"></a>    years <span class="op">=</span> rainfall_wide.year</span>
<span id="cb46-14"><a href="#cb46-14" aria-hidden="true" tabindex="-1"></a>    y_mat <span class="op">=</span> <span class="fu">Matrix</span>(rainfall_wide[<span class="op">:</span>, <span class="fl">2</span><span class="op">:</span><span class="kw">end</span>])  <span class="co"># Drop year column</span></span>
<span id="cb46-15"><a href="#cb46-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-16"><a href="#cb46-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Get x vector (log CO2) for the same years</span></span>
<span id="cb46-17"><a href="#cb46-17" aria-hidden="true" tabindex="-1"></a>    x_vec <span class="op">=</span> <span class="pp">@chain</span> co2_data <span class="cf">begin</span></span>
<span id="cb46-18"><a href="#cb46-18" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@filter</span>(<span class="fu">in</span>(year, !!years))</span>
<span id="cb46-19"><a href="#cb46-19" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@arrange</span>(year)</span>
<span id="cb46-20"><a href="#cb46-20" aria-hidden="true" tabindex="-1"></a>        <span class="pp">@select</span>(log_CO2)</span>
<span id="cb46-21"><a href="#cb46-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb46-22"><a href="#cb46-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb46-23"><a href="#cb46-23" aria-hidden="true" tabindex="-1"></a>    y_mat, x_vec.log_CO2</span>
<span id="cb46-24"><a href="#cb46-24" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<p>The next step I implemented the simplified regional model:</p>
<div id="98" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb47"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="pp">@model</span> <span class="kw">function</span> <span class="fu">regional_nonstationary_gev</span>(y_matrix, x_vector)</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    n_years, n_stations <span class="op">=</span> <span class="fu">size</span>(y_matrix)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Regional parameters (shared across all stations)</span></span>
<span id="cb47-6"><a href="#cb47-6" aria-hidden="true" tabindex="-1"></a>    Œ≤_region <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0.0</span>, <span class="fl">2.0</span>)          <span class="co"># Regional trend (inches per log(ppm))</span></span>
<span id="cb47-7"><a href="#cb47-7" aria-hidden="true" tabindex="-1"></a>    Œæ_region <span class="op">~</span> <span class="fu">Normal</span>(<span class="fl">0.0</span>, <span class="fl">0.2</span>)          <span class="co"># Regional shape parameter</span></span>
<span id="cb47-8"><a href="#cb47-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-9"><a href="#cb47-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Station-specific parameters (independent for each station)</span></span>
<span id="cb47-10"><a href="#cb47-10" aria-hidden="true" tabindex="-1"></a>    Œ±_Œº_stations <span class="op">~</span> <span class="fu">MvNormal</span>(<span class="fu">fill</span>(<span class="fl">3.0</span>, n_stations), I <span class="op">*</span> <span class="fl">2.0</span>)  <span class="co"># Baseline location for each station</span></span>
<span id="cb47-11"><a href="#cb47-11" aria-hidden="true" tabindex="-1"></a>    log_œÉ_stations <span class="op">~</span> <span class="fu">MvNormal</span>(<span class="fu">zeros</span>(n_stations), I <span class="op">*</span> <span class="fl">0.5</span>)    <span class="co"># Scale parameter for each station</span></span>
<span id="cb47-12"><a href="#cb47-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-13"><a href="#cb47-13" aria-hidden="true" tabindex="-1"></a>    œÉ_stations <span class="op">=</span> <span class="fu">exp</span>.(log_œÉ_stations)</span>
<span id="cb47-14"><a href="#cb47-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-15"><a href="#cb47-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Data likelihood - loop over matrix, skip missing values</span></span>
<span id="cb47-16"><a href="#cb47-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> i <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n_years</span>
<span id="cb47-17"><a href="#cb47-17" aria-hidden="true" tabindex="-1"></a>        x_centered <span class="op">=</span> x_vector[i] <span class="op">-</span> <span class="fu">log</span>(<span class="fl">380</span>)  <span class="co"># Center x around ~380 ppm CO2</span></span>
<span id="cb47-18"><a href="#cb47-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> j <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span>n_stations</span>
<span id="cb47-19"><a href="#cb47-19" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> !<span class="fu">ismissing</span>(y_matrix[i, j])</span>
<span id="cb47-20"><a href="#cb47-20" aria-hidden="true" tabindex="-1"></a>                Œº_ij <span class="op">=</span> Œ±_Œº_stations[j] <span class="op">+</span> Œ≤_region <span class="op">*</span> x_centered</span>
<span id="cb47-21"><a href="#cb47-21" aria-hidden="true" tabindex="-1"></a>                dist <span class="op">=</span> <span class="fu">GeneralizedExtremeValue</span>(Œº_ij, œÉ_stations[j], Œæ_region)</span>
<span id="cb47-22"><a href="#cb47-22" aria-hidden="true" tabindex="-1"></a>                y_matrix[i, j] <span class="op">~</span> dist</span>
<span id="cb47-23"><a href="#cb47-23" aria-hidden="true" tabindex="-1"></a>            <span class="cf">end</span></span>
<span id="cb47-24"><a href="#cb47-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">end</span></span>
<span id="cb47-25"><a href="#cb47-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb47-26"><a href="#cb47-26" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb47-27"><a href="#cb47-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-28"><a href="#cb47-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Fit regional model with diagnostics</span></span>
<span id="cb47-29"><a href="#cb47-29" aria-hidden="true" tabindex="-1"></a>regional_idata <span class="op">=</span> <span class="kw">let</span></span>
<span id="cb47-30"><a href="#cb47-30" aria-hidden="true" tabindex="-1"></a>    regional_fname <span class="op">=</span> <span class="fu">joinpath</span>(lab_dir, <span class="st">"regional_nonstat.nc"</span>)</span>
<span id="cb47-31"><a href="#cb47-31" aria-hidden="true" tabindex="-1"></a>    regional_model <span class="op">=</span> <span class="fu">regional_nonstationary_gev</span>(y_matrix, x_vector)</span>
<span id="cb47-32"><a href="#cb47-32" aria-hidden="true" tabindex="-1"></a>    overwrite <span class="op">=</span> <span class="cn">false</span></span>
<span id="cb47-33"><a href="#cb47-33" aria-hidden="true" tabindex="-1"></a>    idata <span class="op">=</span> <span class="fu">load_or_sample</span>(regional_fname, regional_model; overwrite <span class="op">=</span> overwrite, samples_per_chain <span class="op">=</span> <span class="fl">1500</span>)</span>
<span id="cb47-34"><a href="#cb47-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-35"><a href="#cb47-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Check diagnostics immediately after fitting</span></span>
<span id="cb47-36"><a href="#cb47-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">println</span>(<span class="st">"=== Regional Model Diagnostics ==="</span>)</span>
<span id="cb47-37"><a href="#cb47-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">display</span>(ArviZ.<span class="fu">summarize</span>(idata))</span>
<span id="cb47-38"><a href="#cb47-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb47-39"><a href="#cb47-39" aria-hidden="true" tabindex="-1"></a>    idata</span>
<span id="cb47-40"><a href="#cb47-40" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
</div>
<div id="100" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb48"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb48-1"><a href="#cb48-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Traceplots for regional parameters</span></span>
<span id="cb48-2"><a href="#cb48-2" aria-hidden="true" tabindex="-1"></a>regional_traceplots <span class="op">=</span> <span class="kw">let</span></span>
<span id="cb48-3"><a href="#cb48-3" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size <span class="op">=</span> (<span class="fl">1200</span>, <span class="fl">400</span>))</span>
<span id="cb48-4"><a href="#cb48-4" aria-hidden="true" tabindex="-1"></a>    param_names <span class="op">=</span> [<span class="op">:</span>Œ≤_region, <span class="op">:</span>Œæ_region]</span>
<span id="cb48-5"><a href="#cb48-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-6"><a href="#cb48-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i, param) <span class="kw">in</span> <span class="fu">enumerate</span>(param_names)</span>
<span id="cb48-7"><a href="#cb48-7" aria-hidden="true" tabindex="-1"></a>        ax <span class="op">=</span> <span class="fu">Axis</span>(fig[i, <span class="fl">1</span>], xlabel <span class="op">=</span> i <span class="op">==</span> <span class="fu">length</span>(param_names) ? <span class="st">"Iteration"</span> <span class="op">:</span> <span class="st">""</span>,</span>
<span id="cb48-8"><a href="#cb48-8" aria-hidden="true" tabindex="-1"></a>            ylabel <span class="op">=</span> <span class="fu">string</span>(param), title <span class="op">=</span> i <span class="op">==</span> <span class="fl">1</span> ? <span class="st">"Regional Model Parameters"</span> <span class="op">:</span> <span class="st">""</span>)</span>
<span id="cb48-9"><a href="#cb48-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">traceplot!</span>(ax, regional_idata, param)</span>
<span id="cb48-10"><a href="#cb48-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb48-11"><a href="#cb48-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb48-12"><a href="#cb48-12" aria-hidden="true" tabindex="-1"></a>    fig</span>
<span id="cb48-13"><a href="#cb48-13" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="assignment-1_files/figure-html/cell-51-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>For the regional nonstationary GEV, I specify that the trend parameter and the shape parameter are shared across stations, while the baseline location and scale remain station-specific. The reasoning is that long-term climate forcing, represented by <code>CO‚ÇÇ</code>, should influence the direction and heaviness of extremes consistently across a coherent regional cluster, but baseline rainfall levels and variability differ locally due to site conditions. This structure improves identifiability by borrowing strength for trend and tail behavior, which are difficult to estimate reliably at single stations. In practice, my results show that regional pooling reduces posterior uncertainty: return-level bands for 50- and 100-year storms are narrower and trend estimates have smaller posterior standard deviations compared to single-station fits.</p>
<p>For the regional analysis, I defined the boundary by selecting the 8 closest stations to Houston Intercontinental Airport (IAH) with at least 40 years of data. Geographic proximity ensures that all stations experience broadly similar synoptic-scale climate drivers, such as Gulf moisture and tropical storm influences, while the data-length criterion guarantees sufficient record depth for stable estimation. This balance avoids including short or gappy records that inflate uncertainty. At the same time, limiting the region to nearby stations reduces the risk of pooling across climatologically inconsistent areas. he spatial Mann‚ÄìKendall tests also highlighted inconsistencies in single-station trends, reinforcing the value of pooling only across stations within a climatologically coherent neighborhood.</p>
</section>
<section id="comparing-regional-vs-single-station-approaches" class="level2" data-number="4.2">
<h2 data-number="4.2" class="anchored" data-anchor-id="comparing-regional-vs-single-station-approaches"><span class="header-section-number">4.2</span> Comparing Regional vs Single-Station Approaches</h2>
<p>Compare how the regional model performs versus the single-station nonstationary models for our primary station for the 50-year return levels.</p>
<div id="102" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb49"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract regional model results for our primary station</span></span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Re-load necessary variables for proper scoping</span></span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>regional_fname <span class="op">=</span> <span class="fu">joinpath</span>(lab_dir, <span class="st">"regional_nonstat.nc"</span>)</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>regional_idata <span class="op">=</span> ArviZ.<span class="fu">from_netcdf</span>(regional_fname)</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>my_stnid <span class="op">=</span> <span class="fl">782</span></span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>analysis_stnids <span class="op">=</span> analysis_stations.stnid</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>my_station_idx <span class="op">=</span> <span class="fu">findfirst</span>(x <span class="op">-&gt;</span> x <span class="op">==</span> my_stnid, analysis_stnids)</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>regional_my_station <span class="op">=</span> <span class="kw">let</span></span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract regional parameters (shared)</span></span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>    Œ≤_samples <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">Array</span>(regional_idata.posterior[<span class="op">:</span>Œ≤_region]))</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>    Œæ_samples <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">Array</span>(regional_idata.posterior[<span class="op">:</span>Œæ_region]))</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract station-specific parameters for our station</span></span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>    Œ±_Œº_samples <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">Array</span>(regional_idata.posterior[<span class="op">:</span>Œ±_Œº_stations])[<span class="op">:</span>, <span class="op">:</span>, my_station_idx])</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    œÉ_samples <span class="op">=</span> <span class="fu">exp</span>.(<span class="fu">vec</span>(<span class="fu">Array</span>(regional_idata.posterior[<span class="op">:</span>log_œÉ_stations])[<span class="op">:</span>, <span class="op">:</span>, my_station_idx]))</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-19"><a href="#cb49-19" aria-hidden="true" tabindex="-1"></a>    (Œ±_Œº <span class="op">=</span> Œ±_Œº_samples, Œ≤_Œº <span class="op">=</span> Œ≤_samples, œÉ <span class="op">=</span> œÉ_samples, Œæ <span class="op">=</span> Œæ_samples)</span>
<span id="cb49-20"><a href="#cb49-20" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb49-21"><a href="#cb49-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-22"><a href="#cb49-22" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract single-station model results (Model 1: Location trend only)</span></span>
<span id="cb49-23"><a href="#cb49-23" aria-hidden="true" tabindex="-1"></a>single_station <span class="op">=</span> <span class="kw">let</span></span>
<span id="cb49-24"><a href="#cb49-24" aria-hidden="true" tabindex="-1"></a>    model1_idata <span class="op">=</span> posterior_results[<span class="fl">1</span>].idata</span>
<span id="cb49-25"><a href="#cb49-25" aria-hidden="true" tabindex="-1"></a>    Œ±_Œº_samples <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">Array</span>(model1_idata.posterior[<span class="op">:</span>Œ±_Œº]))</span>
<span id="cb49-26"><a href="#cb49-26" aria-hidden="true" tabindex="-1"></a>    Œ≤_Œº_samples <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">Array</span>(model1_idata.posterior[<span class="op">:</span>Œ≤_Œº]))</span>
<span id="cb49-27"><a href="#cb49-27" aria-hidden="true" tabindex="-1"></a>    œÉ_samples <span class="op">=</span> <span class="fu">exp</span>.(<span class="fu">vec</span>(<span class="fu">Array</span>(model1_idata.posterior[<span class="op">:</span>log_œÉ])))</span>
<span id="cb49-28"><a href="#cb49-28" aria-hidden="true" tabindex="-1"></a>    Œæ_samples <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">Array</span>(model1_idata.posterior[<span class="op">:</span>Œæ]))</span>
<span id="cb49-29"><a href="#cb49-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-30"><a href="#cb49-30" aria-hidden="true" tabindex="-1"></a>    (Œ±_Œº <span class="op">=</span> Œ±_Œº_samples, Œ≤_Œº <span class="op">=</span> Œ≤_Œº_samples, œÉ <span class="op">=</span> œÉ_samples, Œæ <span class="op">=</span> Œæ_samples)</span>
<span id="cb49-31"><a href="#cb49-31" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span>
<span id="cb49-32"><a href="#cb49-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-33"><a href="#cb49-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Prepare data for comparison plots</span></span>
<span id="cb49-34"><a href="#cb49-34" aria-hidden="true" tabindex="-1"></a>rts <span class="op">=</span> <span class="fu">logrange</span>(<span class="fl">1.1</span>, <span class="fl">250</span>, <span class="fl">50</span>) <span class="co"># 50-years</span></span>
<span id="cb49-35"><a href="#cb49-35" aria-hidden="true" tabindex="-1"></a>xticks <span class="op">=</span> [<span class="fl">2</span>, <span class="fl">5</span>, <span class="fl">10</span>, <span class="fl">25</span>, <span class="fl">50</span>, <span class="fl">100</span>, <span class="fl">250</span>]</span>
<span id="cb49-36"><a href="#cb49-36" aria-hidden="true" tabindex="-1"></a>x_2025 <span class="op">=</span> co2_data.log_CO2[co2_data.year<span class="op">.==</span><span class="fl">2024</span>][<span class="fl">1</span>]</span>
<span id="cb49-37"><a href="#cb49-37" aria-hidden="true" tabindex="-1"></a>x_centered <span class="op">=</span> x_2025 <span class="op">-</span> <span class="fu">log</span>(<span class="fl">380</span>)</span>
<span id="cb49-38"><a href="#cb49-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-39"><a href="#cb49-39" aria-hidden="true" tabindex="-1"></a><span class="co"># Create GEV distributions for 2025</span></span>
<span id="cb49-40"><a href="#cb49-40" aria-hidden="true" tabindex="-1"></a>Œº_single_2025 <span class="op">=</span> single_station.Œ±_Œº <span class="op">.+</span> single_station.Œ≤_Œº <span class="op">.*</span> x_centered</span>
<span id="cb49-41"><a href="#cb49-41" aria-hidden="true" tabindex="-1"></a>gevs_single <span class="op">=</span> <span class="fu">GeneralizedExtremeValue</span>.(Œº_single_2025, single_station.œÉ, single_station.Œæ)</span>
<span id="cb49-42"><a href="#cb49-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb49-43"><a href="#cb49-43" aria-hidden="true" tabindex="-1"></a>Œº_regional_2025 <span class="op">=</span> regional_my_station.Œ±_Œº <span class="op">.+</span> regional_my_station.Œ≤_Œº <span class="op">.*</span> x_centered</span>
<span id="cb49-44"><a href="#cb49-44" aria-hidden="true" tabindex="-1"></a>gevs_regional <span class="op">=</span> <span class="fu">GeneralizedExtremeValue</span>.(Œº_regional_2025, regional_my_station.œÉ, regional_my_station.Œæ)</span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<pre><code>24000-element Vector{GeneralizedExtremeValue{Float64}}:
 Distributions.GeneralizedExtremeValue{Float64}(Œº=3.498241407566658, œÉ=1.6682429846368692, Œæ=0.20836596028280543)
 Distributions.GeneralizedExtremeValue{Float64}(Œº=3.625799214242691, œÉ=1.692013774425666, Œæ=0.2177353866022649)
 Distributions.GeneralizedExtremeValue{Float64}(Œº=3.6553856445224167, œÉ=1.3218331524812528, Œæ=0.17653929581337235)
 Distributions.GeneralizedExtremeValue{Float64}(Œº=3.533975949217747, œÉ=1.665216483226898, Œæ=0.19486479672972948)
 Distributions.GeneralizedExtremeValue{Float64}(Œº=3.676851474205039, œÉ=1.4632256488941986, Œæ=0.2202951224327875)
 Distributions.GeneralizedExtremeValue{Float64}(Œº=3.624031030158405, œÉ=1.4633410586628552, Œæ=0.2251112893041901)
 Distributions.GeneralizedExtremeValue{Float64}(Œº=3.701067462750299, œÉ=1.4027891180633576, Œæ=0.207354797162331)
 Distributions.GeneralizedExtremeValue{Float64}(Œº=3.4036390577506936, œÉ=1.4341778998394348, Œæ=0.19247738545663381)
 Distributions.GeneralizedExtremeValue{Float64}(Œº=3.52466188132324, œÉ=1.4147878978381057, Œæ=0.20164001614473834)
 Distributions.GeneralizedExtremeValue{Float64}(Œº=3.8246043638951597, œÉ=1.5025437086990672, Œæ=0.23464086490399005)
 ‚ãÆ
 Distributions.GeneralizedExtremeValue{Float64}(Œº=3.437594409369996, œÉ=1.152947345553533, Œæ=0.21053417625873655)
 Distributions.GeneralizedExtremeValue{Float64}(Œº=4.028305759514393, œÉ=1.6960978511340667, Œæ=0.226211384156977)
 Distributions.GeneralizedExtremeValue{Float64}(Œº=3.284850686842242, œÉ=1.262456119675458, Œæ=0.24145230358247263)
 Distributions.GeneralizedExtremeValue{Float64}(Œº=3.616097268184011, œÉ=1.588298075940779, Œæ=0.20138738807176526)
 Distributions.GeneralizedExtremeValue{Float64}(Œº=3.71906783323945, œÉ=1.4664694781105585, Œæ=0.22389749953461374)
 Distributions.GeneralizedExtremeValue{Float64}(Œº=3.5672794492891677, œÉ=1.4589091506987466, Œæ=0.22789647357155948)
 Distributions.GeneralizedExtremeValue{Float64}(Œº=3.6017841134358255, œÉ=1.5208358256201087, Œæ=0.22077673028239134)
 Distributions.GeneralizedExtremeValue{Float64}(Œº=3.442194483878525, œÉ=1.4070585018079873, Œæ=0.2062929208504614)
 Distributions.GeneralizedExtremeValue{Float64}(Œº=3.4606502438448254, œÉ=1.5105041488917017, Œæ=0.21086195876405295)</code></pre>
</div>
</div>
<p>Then generate the return level curves for the comparesion.</p>
<div id="104" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb51"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Return level curves comparison</span></span>
<span id="cb51-2"><a href="#cb51-2" aria-hidden="true" tabindex="-1"></a>return_level_fig <span class="op">=</span> <span class="kw">let</span></span>
<span id="cb51-3"><a href="#cb51-3" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size <span class="op">=</span> (<span class="fl">800</span>, <span class="fl">500</span>))</span>
<span id="cb51-4"><a href="#cb51-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-5"><a href="#cb51-5" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>], xlabel <span class="op">=</span> <span class="st">"Return Period (years)"</span>, ylabel <span class="op">=</span> <span class="st">"Return Level (inches)"</span>,</span>
<span id="cb51-6"><a href="#cb51-6" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="st">"2025 Return Level Comparison: Single-Station vs Regional"</span>,</span>
<span id="cb51-7"><a href="#cb51-7" aria-hidden="true" tabindex="-1"></a>        xscale <span class="op">=</span> log10, xticks <span class="op">=</span> xticks)</span>
<span id="cb51-8"><a href="#cb51-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-9"><a href="#cb51-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Plot uncertainty bands and mean curves</span></span>
<span id="cb51-10"><a href="#cb51-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">posterior_bands!</span>(ax, gevs_single, rts; ci <span class="op">=</span> <span class="fl">0.90</span>, color <span class="op">=</span> (<span class="op">:</span>blue, <span class="fl">0.3</span>))</span>
<span id="cb51-11"><a href="#cb51-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">posterior_mean_curve!</span>(ax, gevs_single, rts; color <span class="op">=</span> <span class="op">:</span>blue, linewidth <span class="op">=</span> <span class="fl">3</span>, label <span class="op">=</span> <span class="st">"Single-Station"</span>)</span>
<span id="cb51-12"><a href="#cb51-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-13"><a href="#cb51-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">posterior_bands!</span>(ax, gevs_regional, rts; ci <span class="op">=</span> <span class="fl">0.90</span>, color <span class="op">=</span> (<span class="op">:</span>red, <span class="fl">0.3</span>))</span>
<span id="cb51-14"><a href="#cb51-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">posterior_mean_curve!</span>(ax, gevs_regional, rts; color <span class="op">=</span> <span class="op">:</span>red, linewidth <span class="op">=</span> <span class="fl">3</span>, label <span class="op">=</span> <span class="st">"Regional"</span>)</span>
<span id="cb51-15"><a href="#cb51-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-16"><a href="#cb51-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axislegend</span>(ax, position <span class="op">=</span> <span class="op">:</span>rb)</span>
<span id="cb51-17"><a href="#cb51-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb51-18"><a href="#cb51-18" aria-hidden="true" tabindex="-1"></a>    fig</span>
<span id="cb51-19"><a href="#cb51-19" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="assignment-1_files/figure-html/cell-53-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Next, compare the parameter uncertainty for different scales.</p>
<div id="106" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb52"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb52-1"><a href="#cb52-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Parameter uncertainty comparison</span></span>
<span id="cb52-2"><a href="#cb52-2" aria-hidden="true" tabindex="-1"></a>parameter_uncertainty_fig <span class="op">=</span> <span class="kw">let</span></span>
<span id="cb52-3"><a href="#cb52-3" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size <span class="op">=</span> (<span class="fl">800</span>, <span class="fl">400</span>))</span>
<span id="cb52-4"><a href="#cb52-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-5"><a href="#cb52-5" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>], xlabel <span class="op">=</span> <span class="st">"Parameter"</span>, ylabel <span class="op">=</span> <span class="st">"Posterior Standard Deviation"</span>,</span>
<span id="cb52-6"><a href="#cb52-6" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="st">"Parameter Uncertainty: Single-Station vs Regional"</span>)</span>
<span id="cb52-7"><a href="#cb52-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-8"><a href="#cb52-8" aria-hidden="true" tabindex="-1"></a>    params <span class="op">=</span> [L<span class="st">"</span><span class="sc">$</span><span class="st">\</span>alpha_<span class="st">\mu</span><span class="sc">$</span><span class="st">", </span>L<span class="st">"</span><span class="op">$\</span>beta_<span class="op">\</span>mu<span class="op">$</span><span class="st">", L"</span><span class="op">$\</span>sigma<span class="op">$</span><span class="st">", L"</span><span class="op">$\</span>xi<span class="op">$</span><span class="st">"]</span></span>
<span id="cb52-9"><a href="#cb52-9" aria-hidden="true" tabindex="-1"></a>    single_stds <span class="op">=</span> [</span>
<span id="cb52-10"><a href="#cb52-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">std</span>(single_station.Œ±_Œº),</span>
<span id="cb52-11"><a href="#cb52-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">std</span>(single_station.Œ≤_Œº),</span>
<span id="cb52-12"><a href="#cb52-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">std</span>(single_station.œÉ),</span>
<span id="cb52-13"><a href="#cb52-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">std</span>(single_station.Œæ),</span>
<span id="cb52-14"><a href="#cb52-14" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb52-15"><a href="#cb52-15" aria-hidden="true" tabindex="-1"></a>    regional_stds <span class="op">=</span> [</span>
<span id="cb52-16"><a href="#cb52-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">std</span>(regional_my_station.Œ±_Œº),</span>
<span id="cb52-17"><a href="#cb52-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">std</span>(regional_my_station.Œ≤_Œº),</span>
<span id="cb52-18"><a href="#cb52-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">std</span>(regional_my_station.œÉ),</span>
<span id="cb52-19"><a href="#cb52-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">std</span>(regional_my_station.Œæ),</span>
<span id="cb52-20"><a href="#cb52-20" aria-hidden="true" tabindex="-1"></a>    ]</span>
<span id="cb52-21"><a href="#cb52-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-22"><a href="#cb52-22" aria-hidden="true" tabindex="-1"></a>    x_pos <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fu">length</span>(params)</span>
<span id="cb52-23"><a href="#cb52-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">barplot!</span>(ax, x_pos <span class="op">.-</span> <span class="fl">0.2</span>, single_stds, width <span class="op">=</span> <span class="fl">0.35</span>, color <span class="op">=</span> <span class="op">:</span>blue, alpha <span class="op">=</span> <span class="fl">0.7</span>, label <span class="op">=</span> <span class="st">"Single-Station"</span>)</span>
<span id="cb52-24"><a href="#cb52-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">barplot!</span>(ax, x_pos <span class="op">.+</span> <span class="fl">0.2</span>, regional_stds, width <span class="op">=</span> <span class="fl">0.35</span>, color <span class="op">=</span> <span class="op">:</span>red, alpha <span class="op">=</span> <span class="fl">0.7</span>, label <span class="op">=</span> <span class="st">"Regional"</span>)</span>
<span id="cb52-25"><a href="#cb52-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-26"><a href="#cb52-26" aria-hidden="true" tabindex="-1"></a>    ax.xticks <span class="op">=</span> (x_pos, params)</span>
<span id="cb52-27"><a href="#cb52-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axislegend</span>(ax, position <span class="op">=</span> <span class="op">:</span>rt)</span>
<span id="cb52-28"><a href="#cb52-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb52-29"><a href="#cb52-29" aria-hidden="true" tabindex="-1"></a>    fig</span>
<span id="cb52-30"><a href="#cb52-30" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="assignment-1_files/figure-html/cell-54-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Generate the 50 years return level uncertainty plots.</p>
<div id="108" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb53"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a><span class="co"># 50-year return level distributions</span></span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>return_level_dist_fig <span class="op">=</span> <span class="kw">let</span></span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size <span class="op">=</span> (<span class="fl">800</span>, <span class="fl">400</span>))</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>    ax <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>], xlabel <span class="op">=</span> <span class="st">"50-year Return Level (inches)"</span>, ylabel <span class="op">=</span> <span class="st">"Density"</span>,</span>
<span id="cb53-6"><a href="#cb53-6" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="st">"50-year Return Level Uncertainty"</span>)</span>
<span id="cb53-7"><a href="#cb53-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-8"><a href="#cb53-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Calculate 100-year return levels</span></span>
<span id="cb53-9"><a href="#cb53-9" aria-hidden="true" tabindex="-1"></a>    rl100_single <span class="op">=</span> [<span class="fu">quantile</span>(gev, <span class="fl">0.99</span>) for gev <span class="kw">in</span> gevs_single]</span>
<span id="cb53-10"><a href="#cb53-10" aria-hidden="true" tabindex="-1"></a>    rl100_regional <span class="op">=</span> [<span class="fu">quantile</span>(gev, <span class="fl">0.99</span>) for gev <span class="kw">in</span> gevs_regional]</span>
<span id="cb53-11"><a href="#cb53-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-12"><a href="#cb53-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hist!</span>(ax, rl100_single, bins <span class="op">=</span> <span class="fl">30</span>, color <span class="op">=</span> (<span class="op">:</span>blue, <span class="fl">0.5</span>), label <span class="op">=</span> <span class="st">"Single-Station"</span>, normalization <span class="op">=</span> <span class="op">:</span>pdf)</span>
<span id="cb53-13"><a href="#cb53-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hist!</span>(ax, rl100_regional, bins <span class="op">=</span> <span class="fl">30</span>, color <span class="op">=</span> (<span class="op">:</span>red, <span class="fl">0.5</span>), label <span class="op">=</span> <span class="st">"Regional"</span>, normalization <span class="op">=</span> <span class="op">:</span>pdf)</span>
<span id="cb53-14"><a href="#cb53-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-15"><a href="#cb53-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axislegend</span>(ax, position <span class="op">=</span> <span class="op">:</span>rt)</span>
<span id="cb53-16"><a href="#cb53-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb53-17"><a href="#cb53-17" aria-hidden="true" tabindex="-1"></a>    fig</span>
<span id="cb53-18"><a href="#cb53-18" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="assignment-1_files/figure-html/cell-55-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>Trend estimates compare between the single-station and regional approaches:</p>
<div id="110" class="cell" data-execution_count="1">
<div class="code-copy-outer-scaffold"><div class="sourceCode cell-code" id="cb54"><pre class="sourceCode julia code-with-copy"><code class="sourceCode julia"><span id="cb54-1"><a href="#cb54-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Compare trend estimates from single-station vs regional models</span></span>
<span id="cb54-2"><a href="#cb54-2" aria-hidden="true" tabindex="-1"></a>trend_comparison_fig <span class="op">=</span> <span class="kw">let</span></span>
<span id="cb54-3"><a href="#cb54-3" aria-hidden="true" tabindex="-1"></a>    fig <span class="op">=</span> <span class="fu">Figure</span>(size <span class="op">=</span> (<span class="fl">1000</span>, <span class="fl">400</span>))</span>
<span id="cb54-4"><a href="#cb54-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-5"><a href="#cb54-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Re-extract needed variables for proper scoping</span></span>
<span id="cb54-6"><a href="#cb54-6" aria-hidden="true" tabindex="-1"></a>    single_idata <span class="op">=</span> posterior_results[<span class="fl">1</span>].idata</span>
<span id="cb54-7"><a href="#cb54-7" aria-hidden="true" tabindex="-1"></a>    regional_fname <span class="op">=</span> <span class="fu">joinpath</span>(lab_dir, <span class="st">"regional_nonstat.nc"</span>)</span>
<span id="cb54-8"><a href="#cb54-8" aria-hidden="true" tabindex="-1"></a>    regional_idata <span class="op">=</span> ArviZ.<span class="fu">from_netcdf</span>(regional_fname)</span>
<span id="cb54-9"><a href="#cb54-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-10"><a href="#cb54-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Extract trend parameters</span></span>
<span id="cb54-11"><a href="#cb54-11" aria-hidden="true" tabindex="-1"></a>    single_Œ≤_Œº <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">Array</span>(single_idata.posterior[<span class="op">:</span>Œ≤_Œº]))</span>
<span id="cb54-12"><a href="#cb54-12" aria-hidden="true" tabindex="-1"></a>    regional_Œ≤_Œº <span class="op">=</span> <span class="fu">vec</span>(<span class="fu">Array</span>(regional_idata.posterior[<span class="op">:</span>Œ≤_region]))</span>
<span id="cb54-13"><a href="#cb54-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-14"><a href="#cb54-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Left plot: trend parameter distributions</span></span>
<span id="cb54-15"><a href="#cb54-15" aria-hidden="true" tabindex="-1"></a>    ax1 <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">1</span>], xlabel <span class="op">=</span> L<span class="st">"Location Trend Parameter </span><span class="sc">$</span><span class="st">\</span>beta_<span class="st">\mu$ (inches per log(ppm))"</span>, ylabel <span class="op">=</span> <span class="st">"Density"</span>,</span>
<span id="cb54-16"><a href="#cb54-16" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="st">"Trend Parameter Estimates"</span>)</span>
<span id="cb54-17"><a href="#cb54-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-18"><a href="#cb54-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hist!</span>(ax1, single_Œ≤_Œº, bins <span class="op">=</span> <span class="fl">30</span>, color <span class="op">=</span> (<span class="op">:</span>blue, <span class="fl">0.5</span>), label <span class="op">=</span> <span class="st">"Single-Station"</span>, normalization <span class="op">=</span> <span class="op">:</span>pdf)</span>
<span id="cb54-19"><a href="#cb54-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">hist!</span>(ax1, regional_Œ≤_Œº, bins <span class="op">=</span> <span class="fl">30</span>, color <span class="op">=</span> (<span class="op">:</span>red, <span class="fl">0.5</span>), label <span class="op">=</span> <span class="st">"Regional"</span>, normalization <span class="op">=</span> <span class="op">:</span>pdf)</span>
<span id="cb54-20"><a href="#cb54-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-21"><a href="#cb54-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">axislegend</span>(ax1, position <span class="op">=</span> <span class="op">:</span>rt)</span>
<span id="cb54-22"><a href="#cb54-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-23"><a href="#cb54-23" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Right plot: uncertainty comparison</span></span>
<span id="cb54-24"><a href="#cb54-24" aria-hidden="true" tabindex="-1"></a>    ax2 <span class="op">=</span> <span class="fu">Axis</span>(fig[<span class="fl">1</span>, <span class="fl">2</span>], xlabel <span class="op">=</span> <span class="st">"Model"</span>, ylabel <span class="op">=</span> <span class="st">"Standard Deviation"</span>,</span>
<span id="cb54-25"><a href="#cb54-25" aria-hidden="true" tabindex="-1"></a>        title <span class="op">=</span> <span class="st">"Trend Parameter Uncertainty"</span>)</span>
<span id="cb54-26"><a href="#cb54-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-27"><a href="#cb54-27" aria-hidden="true" tabindex="-1"></a>    trend_stds <span class="op">=</span> [<span class="fu">std</span>(single_Œ≤_Œº), <span class="fu">std</span>(regional_Œ≤_Œº)]</span>
<span id="cb54-28"><a href="#cb54-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">barplot!</span>(ax2, <span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, trend_stds, color <span class="op">=</span> [<span class="op">:</span>blue, <span class="op">:</span>red], alpha <span class="op">=</span> <span class="fl">0.7</span>)</span>
<span id="cb54-29"><a href="#cb54-29" aria-hidden="true" tabindex="-1"></a>    ax2.xticks <span class="op">=</span> (<span class="fl">1</span><span class="op">:</span><span class="fl">2</span>, [<span class="st">"Single-Station"</span>, <span class="st">"Regional"</span>])</span>
<span id="cb54-30"><a href="#cb54-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-31"><a href="#cb54-31" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Add text labels on bars</span></span>
<span id="cb54-32"><a href="#cb54-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (i, val) <span class="kw">in</span> <span class="fu">enumerate</span>(trend_stds)</span>
<span id="cb54-33"><a href="#cb54-33" aria-hidden="true" tabindex="-1"></a>        <span class="fu">text!</span>(ax2, i, val <span class="op">-</span> <span class="fl">0.25</span>, text <span class="op">=</span> <span class="fu">string</span>(<span class="fu">round</span>(val, digits <span class="op">=</span> <span class="fl">2</span>)),</span>
<span id="cb54-34"><a href="#cb54-34" aria-hidden="true" tabindex="-1"></a>            align <span class="op">=</span> (<span class="op">:</span>center, <span class="op">:</span>bottom), color <span class="op">=</span> <span class="op">:</span>white, fontsize <span class="op">=</span> <span class="fl">16</span>)</span>
<span id="cb54-35"><a href="#cb54-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">end</span></span>
<span id="cb54-36"><a href="#cb54-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb54-37"><a href="#cb54-37" aria-hidden="true" tabindex="-1"></a>    fig</span>
<span id="cb54-38"><a href="#cb54-38" aria-hidden="true" tabindex="-1"></a><span class="kw">end</span></span></code></pre></div><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></div>
<div class="cell-output cell-output-display" data-execution_count="1">
<div>
<figure class="figure">
<p><img src="assignment-1_files/figure-html/cell-56-output-1.svg" class="img-fluid figure-img"></p>
</figure>
</div>
</div>
</div>
<p>The regional approach appears to provide a somewhat more precise estimate of the trend parameter. This improved precision occurs because by pooling the shape parameter and constraining the station-specific parameters, I can get better estimates of the other model components, which in turn help constrain our trend estimate. This demonstrates how regional modeling can sharpen parameter estimates through better overall model specification.</p>
</section>
</section>
<section id="task-5-communication" class="level1" data-number="5">
<h1 data-number="5"><span class="header-section-number">5</span> Task 5: Communication</h1>
<section id="question-1" class="level2" data-number="5.1">
<h2 data-number="5.1" class="anchored" data-anchor-id="question-1"><span class="header-section-number">5.1</span> Question 1</h2>
<p>The belief that 50 years of multiple station data are sufficient to exam how uncertainty compounds in extreme value estimation. Single-station maximum likelihood methods produce point estimates with deceptively narrow confidence intervals, yet their reliability is undermined by short and noisy records. In my analyses at Houston Intercontinental Airport, the Bayesian approach explicitly quantified parameter uncertainty by generating full posterior distributions, revealing that 50- and 100-year return levels carried wide credible intervals that MLE alone could not capture. Extending the single station to a regional Bayesian framework further reduced variance by pooling information across nearby climatologically coherent stations. By sharing trend and shape parameters regionally while retaining site-specific baselines and scales, the model produced tighter return-level bands and more compact histograms of return levels, without biasing the central estimate. The multi-station test demonstrates that climate-informed Bayesian regional modeling does not add unnecessary complexity but instead stabilizes design values and reduces noise-driven overestimation.</p>
</section>
<section id="question-2" class="level2" data-number="5.2">
<h2 data-number="5.2" class="anchored" data-anchor-id="question-2"><span class="header-section-number">5.2</span> Question 2</h2>
<p>Evidence from both the single-station and regional analyses shows that assuming stationarity risks underestimating future extremes. At IAH, nonstationary GEV models with <code>(CO‚ÇÇ)</code> as a covariate revealed clear upward shifts in return level curves from 1950 to 2025, with the 100-year return level distributions moving several inches higher under rising <code>CO‚ÇÇ</code>. Even though <code>location-only</code> and <code>location+scale</code> models produced similar mean projections, their consistent divergence from stationary fits demonstrates that climate forcing cannot be ignored. Prior specification also matters. Weakly informative priors on the scale trend prevented overfitting while still allowing the model to detect credible increases in variability. Posterior diagnostics also confirmed well-mixed chains and stable inference. For critical infrastructure, such underestimation translates into increased failure risk, higher life-cycle costs, and cascading social impacts when systems designed to past climate baselines face intensifying rainfall extremes. Nonstationary Bayesian models therefore offer not just academic refinement, but a practical safeguard against underbuilding in the face of documented climate-driven change.</p>
</section>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "Óßã";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
        for (let i=0; i<annoteTargets.length; i++) {
          const annoteTarget = annoteTargets[i];
          const targetCell = annoteTarget.getAttribute("data-target-cell");
          const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
          const contentFn = () => {
            const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
            if (content) {
              const tipContent = content.cloneNode(true);
              tipContent.classList.add("code-annotation-tip-content");
              return tipContent.outerHTML;
            }
          }
          const config = {
            allowHTML: true,
            content: contentFn,
            onShow: (instance) => {
              selectCodeLines(instance.reference);
              instance.reference.classList.add('code-annotation-active');
              window.tippy.hideAll();
            },
            onHide: (instance) => {
              unselectCodeLines();
              instance.reference.classList.remove('code-annotation-active');
            },
            maxWidth: 300,
            delay: [50, 0],
            duration: [200, 0],
            offset: [5, 10],
            arrow: true,
            appendTo: function(el) {
              return el.parentElement.parentElement.parentElement;
            },
            interactive: true,
            interactiveBorder: 10,
            theme: 'quarto',
            placement: 'right',
            popperOptions: {
              modifiers: [
              {
                name: 'flip',
                options: {
                  flipVariations: false, // true by default
                  allowedAutoPlacements: ['right'],
                  fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
                },
              },
              {
                name: 'preventOverflow',
                options: {
                  mainAxis: false,
                  altAxis: false
                }
              }
              ]        
            }      
          };
          window.tippy(annoteTarget, config); 
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>